<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Степа: Курский Должник 3.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js "></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css ">
    <style>
        :root {
            --bg-start: #10101b;
            --bg-end: #1c1c2b;
            --primary: #f02d54;
            --secondary: #0f3460;
            --text: #e0e0e0;
            --glass-bg: rgba(40, 40, 60, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success: #39d353;
            --danger: #f85149;
            --warning: #ffab00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        html {
            scroll-behavior: smooth;
        }

        body {
            background: linear-gradient(160deg, var(--bg-start) 0%, var(--bg-end) 100%);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            padding: 15px;
            overflow-x: hidden;
            touch-action: manipulation;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            background: var(--glass-bg);
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        h1 {
            font-size: 1.4rem;
            text-align: center;
            color: var(--primary);
            text-shadow: 0 0 15px var(--primary);
            margin-bottom: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            font-size: 0.85rem;
            border-left: 3px solid var(--primary); 
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text);
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .progress-container { margin-top: 10px; font-size: 0.8rem; }
        .progress-bar { height: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        #stress-bar { background: linear-gradient(90deg, #ffab00, #f85149); }
        #health-bar { background: linear-gradient(90deg, #39d353, #8bc34a); }
        #satiety-bar { background: linear-gradient(90deg, #ffc107, #ffab00); }
        
        .character-container {
            text-align: center;
            margin: 15px 0;
            font-size: 5rem;
            perspective: 500px;
        }
        #stepa-emoji {
            display: inline-block;
            animation: idle-bob 4s ease-in-out infinite;
            transition: transform 0.3s ease;
        }

        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .action-btn {
            padding: 10px 5px;
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 80px;
        }
        .action-btn i { font-size: 1.4rem; color: var(--primary); }
        .action-btn:hover { background: rgba(240, 45, 84, 0.2); transform: translateY(-3px); }
        .action-btn:active { transform: translateY(-1px) scale(0.98); background: rgba(240, 45, 84, 0.3); }
        
        .events {
            background: var(--glass-bg);
            padding: 15px;
            border-radius: 20px;
            height: 120px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            font-size: 0.85rem;
        }
        .event { padding: 8px; margin-bottom: 8px; border-radius: 8px; background: rgba(0, 0, 0, 0.2); border-left: 4px solid var(--secondary); animation: slideIn 0.4s ease-out; }
        .event.danger { border-left-color: var(--danger); }
        .event.success { border-left-color: var(--success); }
        .event.warning { border-left-color: var(--warning); }
        
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; animation: fadeIn 0.3s ease;
        }
        .modal.show { display: flex; }
        
        .modal-content {
            background: linear-gradient(135deg, var(--bg-end), var(--bg-start)); padding: 25px; border-radius: 20px; max-width: 500px; width: 100%;
            max-height: 85vh; overflow-y: auto; border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            animation: scale-up-center 0.4s cubic-bezier(0.390, 0.575, 0.565, 1.000);
        }
        
        .modal-content h3 { color: var(--primary); margin-bottom: 15px; text-align: center; }
        .modal-close { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; margin-top: 20px; width: 100%; transition: background 0.2s ease; }
        .modal-close:hover { background: #d83a56; }
        
        .option {
            background: var(--glass-bg); padding: 15px; margin: 10px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; border-left: 4px solid var(--primary);
        }
        .option:hover { background: rgba(233, 69, 96, 0.2); transform: translateX(5px); }
        .option button { background-color: var(--primary); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; margin-top: 10px; float: right; font-size: 0.8rem;}
        .option button.repay { background-color: var(--success); }

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 90%; max-width: 400px;}
        .toast { background: var(--glass-bg); backdrop-filter: blur(10px); padding: 12px 18px; border-radius: 12px; color: var(--text); font-size: 0.9rem; border-left: 5px solid var(--primary); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); width: 100%; animation: slideInTop 0.5s ease-out, fadeOut 0.5s ease-in 3.5s forwards; }
        .toast.success { border-left-color: var(--success); } .toast.danger { border-left-color: var(--danger); } .toast.warning { border-left-color: var(--warning); }

        /* --- Стили для Загрузочного экрана --- */
        .welcome-screen {
            text-align: left;
        }

        .welcome-screen h3 {
            font-size: 1.6rem;
            color: var(--danger);
            text-shadow: 0 0 10px var(--danger);
            animation: flash 1s infinite alternate;
        }

        .welcome-screen p, .welcome-screen li {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 5px;
        }

        .welcome-screen ol, .welcome-screen ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .welcome-screen li strong {
            color: var(--warning);
        }
        
        /* --- АНИМАЦИИ --- */
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInTop { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scale-up-center { from { transform: scale(0.5); opacity: 0.5; } to { transform: scale(1); opacity: 1; } }
        @keyframes flash { from { opacity: 1; } to { opacity: 0.7; } }

        .flash-green { animation: flash-green 0.7s ease; } @keyframes flash-green { 0%, 100% { color: var(--text); transform: scale(1); } 50% { color: var(--success); transform: scale(1.15); } }
        .flash-red { animation: flash-red 0.7s ease; } @keyframes flash-red { 0%, 100% { color: var(--text); transform: scale(1); } 50% { color: var(--danger); transform: scale(1.15); } }
        
        /* Анимации Степы */
        @keyframes idle-bob { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(2deg); } }
        @keyframes danger-shake { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 10% { transform: translate(-3px, 0) rotate(-2deg); } 20% { transform: translate(3px, 0) rotate(2deg); } 30%, 50%, 70% { transform: translate(-3px, 0) rotate(-2deg); } 40%, 60%, 80% { transform: translate(3px, 0) rotate(2deg); } 90% { transform: translate(0, 0) rotate(0); } }
        @keyframes money-bounce { 0% { transform: scale(1) translateY(0); } 30% { transform: scale(1.2) translateY(-15px) rotate(10deg); } 60% { transform: scale(0.9) translateY(5px); } 100% { transform: scale(1) translateY(0); } }
        @keyframes dizzy { 0%, 100% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(15deg) scale(1.1); } 75% { transform: rotate(-15deg) scale(1.1); } }
        
        /* Новые угарные фишки */
        .ugly-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        .ugly-element {
            position: absolute;
            font-size: 2rem;
            opacity: 0;
            animation: float 10s linear infinite;
        }
        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- Угарные элементы -->
    <div class="ugly-container" id="ugly-container"></div>

    <div id="welcome-modal" class="modal show">
        <div class="modal-content welcome-screen">
            <h3>🚨 СТЕПА: КУРСКИЙ ДОЛЖНИК 3.0 🚨</h3>
            <hr style="margin: 15px 0; border-color: var(--primary);"/>
            <p><strong>Суть игры, мудила:</strong></p>
            <ol>
                <li>У тебя долг: <strong>100 000 ₽</strong>.</li>
                <li>Ты должен его вернуть Серёге до 30 дн. Иначе — пиздец.</li>
                <li>Въебывай, жри, снимай стресс, ищи схемы.</li>
            </ol>
            <p><strong>Как не сдохнуть, епта:</strong></p>
            <ul>
                <li>💀 Здоровье 0: Умрешь.</li>
                <li>🤯 Стресс 100: Улетишь кукухой в дурку.</li>
                <li>🍽️ Сытость 0: Начнешь терять здоровье от голода.</li>
            </ul>
            <p style="margin-top: 15px; text-align: center; color: var(--success);"><strong>ГОТОВЬСЯ ЖИТЬ, СУКА!</strong></p>
            <button class="modal-close" onclick="hideModal('welcome-modal')">НАЧАТЬ ЭТУ ХУЙНЮ</button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>🐷 СТЕПА: КУРСКИЙ ДОЛЖНИК 3.0</h1>
            <div class="stats">
                <div class="stat-item">День<br><span class="stat-value" id="day">1</span></div>
                <div class="stat-item">Деньги<br><span class="stat-value" id="money">5000 ₽</span></div>
                <div class="stat-item">Долг<br><span class="stat-value" id="debt">100 000 ₽</span></div>
                <div class="stat-item">Работа<br><span class="stat-value" id="job">Бомж</span></div>
            </div>
            <div class="progress-container">Здоровье: <span id="health-value">100</span>/100<div class="progress-bar"><div class="progress-fill" id="health-bar"></div></div></div>
            <div class="progress-container">Сытость: <span id="satiety-value">100</span>/100<div class="progress-bar"><div class="progress-fill" id="satiety-bar"></div></div></div>
            <div class="progress-container">Стресс: <span id="stress-value">0</span>/100<div class="progress-bar"><div class="progress-fill" id="stress-bar"></div></div></div>
        </div>
        
        <div class="character-container"><span id="stepa-emoji">😴</span></div>
        
        <div class="actions">
            <button class="action-btn" onclick="work()"><i class="fa-solid fa-person-digging"></i><span>Работать, блядь!</span></button>
            <button class="action-btn" onclick="showFoodModal()"><i class="fa-solid fa-burger"></i><span>Пожрать</span></button>
            <button class="action-btn" onclick="showFriendsModal()"><i class="fa-solid fa-users"></i><span>Кенты</span></button>
            <button class="action-btn" onclick="relieveStress()"><i class="fa-solid fa-beer-mug-empty"></i><span>Забухать</span></button>
            <button class="action-btn" onclick="showShadyDealsModal()"><i class="fa-solid fa-skull-crossbones"></i><span>Мутные схемы</span></button>
            <button class="action-btn" onclick="findJob()"><i class="fa-solid fa-briefcase"></i><span>Найти работу</span></button>
            <button class="action-btn" onclick="payDebt()"><i class="fa-solid fa-hand-holding-dollar"></i><span>Отдать долг</span></button>
        </div>
        
        <div class="events" id="events"></div>
    </div>
    
    <div id="friends-modal" class="modal"><div class="modal-content"><h3>👥 Кенты (Должен вернуть, сука)</h3><div id="friends-options"></div><button class="modal-close" onclick="hideModal('friends-modal')">Закрыть</button></div></div>
    <div id="food-modal" class="modal"><div class="modal-content"><h3>🍔 Пожрать (Заткнуть ебало)</h3><div id="food-options"></div><button class="modal-close" onclick="hideModal('food-modal')">Закрыть</button></div></div>
    <div id="shady-deals-modal" class="modal"><div class="modal-content"><h3>😈 Мутные схемы (Наебать судьбу)</h3><div id="shady-deals-options"></div><button class="modal-close" onclick="hideModal('shady-deals-modal')">Закрыть</button></div></div>
    <div id="game-over-modal" class="modal"><div class="modal-content game-over"><h2 id="game-over-title"></h2><p id="game-over-text"></p><button class="modal-close" onclick="restartGame()">Начать эту хуйню заново</button></div></div>

    <script>
        const tg = window.TeleApp.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // --- АУДИОСИСТЕМА ---
        const audioSystem = {
            sounds: {
                work: new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'),
                eat: new Audio('audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'),
                drink: new Audio('audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'),
                win: new Audio('audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'),
                lose: new Audio('audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'),
                cash: new Audio('audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'),
                danger: new Audio('audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'),
                meme: new Audio('audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA')
            },
            play: (name) => {
                if (audioSystem.sounds[name]) {
                    audioSystem.sounds[name].currentTime = 0;
                    audioSystem.sounds[name].play().catch(e => console.log('Audio play error:', e));
                }
            }
        };

        // --- Виброотклик ---
        function haptic(type) {
            if (!tg.HapticFeedback) return;
            try {
                const styles = { error: 'error', success: 'success', warning: 'warning', light: 'light', medium: 'medium' };
                const hapticType = styles[type] || 'light';
                if(['error', 'success', 'warning'].includes(hapticType)) tg.HapticFeedback.notificationOccurred(hapticType);
                else tg.HapticFeedback.impactOccurred(hapticType);
            } catch (e) { /* Игнорируем ошибки */ }
        }
        
        // --- Игровое состояние ---
        const initialGameState = {
            day: 1, money: 5000, debt: 100000, health: 100, satiety: 100, stress: 0,
            job: { name: "Бомж", salary: 750, stress: 5, health: -5, satiety: -15 },
            friends: [
                { name: "Васян", desc: "Старый друг, но сам в жопе", maxLoan: 5000, chance: 0.6, debtAmount: 0 },
                { name: "Петруха", desc: "Жадный, считает каждую копейку", maxLoan: 3000, chance: 0.3, debtAmount: 0 },
                { name: "Семёныч", desc: "Душа-парень, но под каблуком", maxLoan: 7000, chance: 0.7, debtAmount: 0 },
                { name: "Гриша Кабан", desc: "Браток, даст под лютый процент", maxLoan: 15000, chance: 0.85, debtAmount: 0 }
            ],
            gameOver: false,
        };
        let gameState;

        // --- Константы и данные ---
        const food = [
            { name: "Доширак с мазиком", cost: 100, satiety: 20, health: -2, stress: 5 },
            { name: "Шаурма 'Пронеси, Господи'", cost: 250, satiety: 40, health: 5, stress: 0 },
            { name: "Комплексный обед 'Ностальгия'", cost: 500, satiety: 60, health: 10, stress: -5 },
            { name: "Загул в 'Разгуляе'", cost: 2500, satiety: 100, health: -10, stress: -35 } 
        ];
        const jobs = [
            { name: "Грузчик (ебаный)", salary: 1500, stress: 15, health: -10, satiety: -20 },
            { name: "Курьер на велике (заебался)", salary: 2000, stress: 10, health: -5, satiety: -25 },
            { name: "Охранник в 'Пятерочке' (хуй стоять)", salary: 2500, stress: 5, health: 0, satiety: -10 },
            { name: "Таксист 'Ветерок' (похуй, едем)", salary: 3500, stress: 20, health: -5, satiety: -15 }
        ];
        const shadyDeals = [
            { name: "Поставить на 'Рыжего'", desc: "Собачьи бои. Говорят, верняк. Ставка - косарь.", cost: 1000, reward: 5000, chance: 0.4, penalty: -1000, stress: 20},
            { name: "Помочь 'перевезти диван'", desc: "В 3 часа ночи. Вопросы лучше не задавать, мудак.", cost: 0, reward: 8000, chance: 0.6, penalty: -5000, stress: 30},
            { name: "Продать 'витамины' у клуба", desc: "Какой-то порошок. Профит: 10к, если мусора не примут.", cost: -2000, reward: 10000, chance: 0.3, penalty: -10000, stress: 50}
        ];
        const phrases = {
            work: ["Въебывал как раб на галерах, блядь.", "Горбатился за гроши, проклиная всё на свете.", "Продал еще один день жизни за ебучие копейки.", "Имитировал бурную деятельность, заебался."],
            workBonus: ["Начальник был в запое и случайно выписал премию. Повезло, хули.", "Нашел кошелек в раздевалке. Никто не видел, ты красава.", "Клиент оставил щедрые чаевые. Охуеть."],
            workPenalty: ["Уроненный поддон с товаром списали на тебя, мудила.", "Опоздал на смену, получил штраф. Ебать, ты лох.", "Проспал и не вышел. Минус зарплата. Соси хуй."],
            debtThreats: ["📞 Серёга: 'Слышь, уебан, бабки где? Я твой дом труба шатал!'", "📞 Серёга: 'Степа, я твоим ебалом асфальт удобрять буду!'", "SMS от Серёги: 'Твои почки стоят 100к. У тебя есть выбор, сука.'", "SMS от Серёги: 'Я знаю где живет твоя мамка. Время пошло. Пиздец.'"],
            friendReject: ["послал тебя нахуй.", "сказал, что его жена против. Тряпка.", "сделал вид, что не узнал тебя, пидора.", "сказал, 'долг платежом красен' и съебался в закат."],
            gameOver: {
                health: "Ты сдох от какой-то хуйни, потому что не следил за здоровьем, мудак. Твои долги перешли коту. Мяу.",
                stress: "Твоя кукуха окончательно улетела. Остаток жизни ты проведешь, пуская слюни в дурке и крича 'Где деньги, Лебовски?'. Ебать, позорище.",
                debt: "Терпение Серёги лопнуло. Тебя вывезли в лес и креативно обьяснили, что так делать нельзя. Твои останки до сих пор ищут, лол.",
                win: "Ебать, ты реально смог! Отдал все долги и выжил в этом гадюшнике. Теперь ты легенда Курска. Можешь съебать отсюда с чистой совестью, красава."
            }
        };

        // --- Угарные фишки ---
        const uglyElements = ['🐷', '💩', ' Fucked up', 'LOL', 'ROFL', 'KEK', 'MEME', '😂', '🤡', '💀'];
        function createUglyElement() {
            const container = document.getElementById('ugly-container');
            const element = document.createElement('div');
            element.className = 'ugly-element';
            element.textContent = uglyElements[Math.floor(Math.random() * uglyElements.length)];
            element.style.left = Math.random() * 100 + 'vw';
            element.style.animationDuration = (5 + Math.random() * 10) + 's';
            element.style.fontSize = (1 + Math.random() * 3) + 'rem';
            element.style.color = `hsl(${Math.random() * 360}, 100%, 70%)`;
            container.appendChild(element);
            
            setTimeout(() => {
                element.remove();
            }, 10000);
        }

        // --- Управление UI ---
        const ui = {
            day: document.getElementById('day'), money: document.getElementById('money'), debt: document.getElementById('debt'), job: document.getElementById('job'),
            health: document.getElementById('health-value'), healthBar: document.getElementById('health-bar'),
            satiety: document.getElementById('satiety-value'), satietyBar: document.getElementById('satiety-bar'),
            stress: document.getElementById('stress-value'), stressBar: document.getElementById('stress-bar'),
            stepaEmoji: document.getElementById('stepa-emoji'), events: document.getElementById('events'), toastContainer: document.getElementById('toast-container'),
            welcomeModal: document.getElementById('welcome-modal')
        };
        
        function updateUI() {
            animateStatUpdate(ui.day, gameState.day);
            animateStatUpdate(ui.money, gameState.money.toLocaleString('ru-RU') + ' ₽');
            animateStatUpdate(ui.debt, gameState.debt.toLocaleString('ru-RU') + ' ₽');
            animateStatUpdate(ui.job, gameState.job.name);
            
            ui.health.textContent = gameState.health; ui.healthBar.style.width = `${gameState.health}%`;
            ui.satiety.textContent = gameState.satiety; ui.satietyBar.style.width = `${gameState.satiety}%`;
            ui.stress.textContent = gameState.stress; ui.stressBar.style.width = `${gameState.stress}%`;

            updateStepaEmoji();
        }

        let statUpdateTimers = {};
        function animateStatUpdate(element, newValue) {
            const key = element.id;
            const oldValue = element.textContent;
            if (oldValue === String(newValue)) return;

            const isNumber = !isNaN(parseFloat(oldValue.replace(/\s|₽/g, ''))) && !isNaN(parseFloat(String(newValue).replace(/\s|₽/g, '')));
            let changeClass = '';
            if (isNumber) {
                const oldNum = parseFloat(oldValue.replace(/\s|₽/g, ''));
                const newNum = parseFloat(String(newValue).replace(/\s|₽/g, ''));
                if (newNum > oldNum) changeClass = 'flash-green';
                if (newNum < oldNum) changeClass = 'flash-red';
            }

            element.textContent = newValue;

            if (changeClass) {
                clearTimeout(statUpdateTimers[key]);
                element.classList.remove('flash-green', 'flash-red');
                void element.offsetWidth;
                element.classList.add(changeClass);
                statUpdateTimers[key] = setTimeout(() => element.classList.remove(changeClass), 700);
            }
        }

        function changeStat(stat, value) {
            gameState[stat] = Math.max(0, gameState[stat] + value);
            if (['stress', 'health', 'satiety'].includes(stat)) gameState[stat] = Math.min(100, gameState[stat]);
        }
        
        function setStepaAnimation(animation, duration) {
            ui.stepaEmoji.style.animation = 'none';
            void ui.stepaEmoji.offsetWidth;
            ui.stepaEmoji.style.animation = `${animation} ${duration}s ease-in-out`;
            setTimeout(() => {
                ui.stepaEmoji.style.animation = 'idle-bob 4s ease-in-out infinite';
            }, duration * 1000);
        }
        
        function updateStepaEmoji() {
            if (ui.stepaEmoji.style.animationName === 'dizzy') return; 

            if (gameState.stress >= 80) ui.stepaEmoji.textContent = '😡';
            else if (gameState.health <= 20) ui.stepaEmoji.textContent = '💀';
            else if (gameState.satiety <= 20) ui.stepaEmoji.textContent = '🤢';
            else if (gameState.money > 50000) ui.stepaEmoji.textContent = '🤑';
            else if (gameState.money < 1000) ui.stepaEmoji.textContent = '😭';
            else if (gameState.debt > gameState.money * 10) ui.stepaEmoji.textContent = '😱';
            else ui.stepaEmoji.textContent = '😐';
        }

        function addEvent(message, type = "default") {
            const eventEl = document.createElement('div');
            eventEl.className = `event ${type}`;
            eventEl.innerHTML = `<b>День ${gameState.day}:</b> ${message}`;
            ui.events.prepend(eventEl);
            if(ui.events.children.length > 20) ui.events.lastChild.remove();
        }

        function showToast(message, type = "default") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            ui.toastContainer.appendChild(toast);
            
            const hapticMap = { danger: 'error', success: 'success', warning: 'warning', default: 'light' };
            
            if (hapticMap[type]) haptic(hapticMap[type]);
            if (type === 'danger' && Math.random() < 0.5) setStepaAnimation('danger-shake', 1.5); 
            
            setTimeout(() => toast.remove(), 4000);
        }
        
        // --- Главный игровой цикл - СМЕНА ДНЯ ---
        function nextDay() {
            if (gameState.gameOver) return;
            changeStat('day', 1);
            
            // Ежедневные дебаффы
            changeStat('satiety', -10);
            if (gameState.satiety <= 0) {
                changeStat('health', -10);
                addEvent("От голода сводит живот. Теряешь здоровье, хуила.", "danger");
            }
            if(gameState.stress > 0) changeStat('stress', -2); 

            // Шанс на событие
            if (Math.random() < 0.3) randomEvent();
            // Звонок от Сереги
            if (gameState.day > 2 && gameState.day % 4 === 0 && gameState.debt > 0) creditorHarassment();

            // Угарные фишки
            if (Math.random() < 0.1) createUglyElement();

            updateUI();
            checkGameOver();
            saveGame();
        }
        
        // --- Действия игрока ---
        function work() {
            const { salary, stress, health, satiety } = gameState.job;
            let finalSalary = salary;
            let eventMsg = phrases.work[Math.floor(Math.random() * phrases.work.length)];
            
            const rand = Math.random();
            const isHomeless = gameState.job.name.includes("Бомж");

            if (rand < 0.1 && !isHomeless) { 
                finalSalary *= 1.5;
                eventMsg = phrases.workBonus[Math.floor(Math.random() * phrases.workBonus.length)];
                showToast(`Премия, сука! +${(finalSalary - salary).toLocaleString()} ₽`, 'success');
                audioSystem.play('cash');
            } else if (rand < 0.15) { 
                const fine = isHomeless ? 0 : 500; 
                finalSalary = Math.max(0, salary - fine); 
                if (salary > finalSalary) {
                     changeStat('money', -(salary - finalSalary));
                     showToast(`Штраф! Минус бабки, уебок. -${(salary - finalSalary).toLocaleString()} ₽`, 'danger');
                     eventMsg = phrases.workPenalty[Math.floor(Math.random() * phrases.workPenalty.length)];
                     audioSystem.play('danger');
                }
            } else if (isHomeless && rand < 0.3) {
                finalSalary += 200;
                eventMsg = "Нашел несколько бутылок и сдал их. Мелочь, но приятно, бомжара.";
                audioSystem.play('cash');
            }

            changeStat('money', finalSalary);
            changeStat('stress', stress);
            changeStat('health', health);
            changeStat('satiety', satiety);

            haptic('light');
            setStepaAnimation('money-bounce', 1);
            audioSystem.play('work');
            addEvent(`${eventMsg} Заработано: ${finalSalary.toLocaleString()} ₽.`);
            
            nextDay(); 
        }

        function findJob() {
            if (gameState.job.name !== "Бомж" && Math.random() > 0.6) {
                 showToast("У тебя уже есть работа, мудила! Хочешь вторую? Перехочешь!", 'warning');
                 changeStat('stress', 5);
                 return;
            }

            if (Math.random() > 0.4) {
                const newJob = jobs[Math.floor(Math.random() * jobs.length)];
                gameState.job = newJob;
                showToast(`Ты нашел новую работу: ${newJob.name}! Наконец-то, блядь!`, 'success');
                addEvent(`Наконец-то ты не бомж, а "${newJob.name}".`);
                audioSystem.play('meme');
            } else {
                showToast("Никому ты нахуй не нужен, неудачник. Ищи дальше.", 'danger');
                changeStat('stress', 10);
                audioSystem.play('lose');
            }
            updateUI();
            saveGame();
        }
        
        function relieveStress() {
            if (gameState.money < 1000) { showToast("Денег нет даже на бояру, иди нахуй!", "danger"); return; }
            if (gameState.stress < 10) { showToast("Какой-то ты нестрессовый сегодня. Поработай сначала.", "warning"); return; }
            
            changeStat('money', -1000); changeStat('stress', -40); changeStat('health', -5);
            haptic('medium');
            ui.stepaEmoji.textContent = '🥴';
            setStepaAnimation('dizzy', 2);
            setTimeout(() => updateStepaEmoji(), 2000);
            addEvent("Просадил 1000 ₽ в баре. Стало легче, но печень передает привет. Хули, похуй.");
            audioSystem.play('drink');
            updateUI();
            saveGame();
        }
        
        function payDebt() {
            const payment = Math.min(gameState.money, 20000); 
            if (payment <= 0) { showToast("Нечем платить, ты нищий кусок говна!", "danger"); return; }
            changeStat('money', -payment); changeStat('debt', -payment); changeStat('stress', -20);
            showToast(`Отдал ${payment.toLocaleString()} ₽. Серёга сегодня не будет ломать тебе ноги. Пока что.`, "success");
            audioSystem.play('cash');
            updateUI(); checkGameOver(); saveGame();
        }

        // --- Модальные окна ---
        function showModal(id) { document.getElementById(id).classList.add('show'); haptic('light');}
        function hideModal(id) { document.getElementById(id).classList.remove('show');}

        function showFriendsModal() {
            const container = document.getElementById('friends-options'); container.innerHTML = '';
            gameState.friends.forEach(friend => {
                const el = document.createElement('div'); el.className = 'option';
                let button;
                if (friend.debtAmount > 0) button = `<button class="repay" onclick="repayFriend('${friend.name}')">Вернуть ${friend.debtAmount.toLocaleString()} ₽</button>`;
                else button = `<button onclick="borrowFromFriend('${friend.name}')">Занять ${friend.maxLoan.toLocaleString()} ₽</button>`;
                el.innerHTML = `<strong>${friend.name}</strong><br><small>${friend.desc}</small>${button}`;
                container.appendChild(el);
            });
            showModal('friends-modal');
        }
        
        function borrowFromFriend(name) {
            const friend = gameState.friends.find(f => f.name === name);
            if (friend.debtAmount > 0) { showToast(`${friend.name}: "Сначала верни старое, пёс!"`, 'warning'); return; }
            if (gameState.debt > 150000) { showToast(`${friend.name}: "Слышал про твой долг Серёге. Нахуй, я пас."`, 'danger'); changeStat('stress', 5); return; }

            if (Math.random() <= friend.chance) {
                changeStat('money', friend.maxLoan); friend.debtAmount = friend.maxLoan;
                showToast(`${friend.name} одолжил ${friend.maxLoan.toLocaleString()} ₽. "Верни, сука, а то хуже будет"`, 'success');
                audioSystem.play('cash');
            } else {
                changeStat('stress', 15);
                showToast(`${friend.name} ${phrases.friendReject[Math.floor(Math.random() * phrases.friendReject.length)]}`, 'danger');
                audioSystem.play('lose');
            }
            hideModal('friends-modal'); updateUI(); saveGame();
        }

        function repayFriend(name) {
             const friend = gameState.friends.find(f => f.name === name);
             if (gameState.money < friend.debtAmount) { showToast("Нет бабок, чтобы вернуть долг, пиздец!", "danger"); return; }
             changeStat('money', -friend.debtAmount);
             showToast(`Ты вернул долг ${friend.name}. Он снова считает тебя человеком. Красава.`, 'success');
             friend.debtAmount = 0;
             audioSystem.play('meme');
             hideModal('friends-modal'); updateUI(); saveGame();
        }

        function showFoodModal() {
            const container = document.getElementById('food-options'); container.innerHTML = '';
            food.forEach(item => {
                const el = document.createElement('div'); el.className = 'option';
                const stressText = item.stress < 0 ? `Стресс: ${item.stress}` : (item.stress > 0 ? `Стресс: +${item.stress}` : 'Стресс: 0');
                el.innerHTML = `<strong>${item.name}</strong> - ${item.cost.toLocaleString()} ₽<br><small>Сытость: +${item.satiety}, Здоровье: ${item.health > 0 ? '+':''}${item.health}, ${stressText}</small>`;
                el.onclick = () => eat(item.name); container.appendChild(el);
            });
            showModal('food-modal');
        }

        function eat(name) {
            const foodItem = food.find(f => f.name === name);
            if (gameState.money < foodItem.cost) { showToast("Денег нет даже на еду, иди работай, хуесос!", "danger"); return; }
            changeStat('money', -foodItem.cost); changeStat('satiety', foodItem.satiety); changeStat('health', foodItem.health); changeStat('stress', foodItem.stress);
            addEvent(`Поел: "${foodItem.name}". Заткнул свое ебало. Хоть какая-то радость.`);
            audioSystem.play('eat');
            hideModal('food-modal'); updateUI(); saveGame();
        }

        function showShadyDealsModal() {
            const container = document.getElementById('shady-deals-options'); container.innerHTML = '';
            shadyDeals.forEach(deal => {
                const el = document.createElement('div');
                el.className = 'option';
                const costDisplay = deal.cost < 0 ? `Продажа (+${Math.abs(deal.cost).toLocaleString()} ₽)` : `Ставка: ${deal.cost.toLocaleString()} ₽`;
                el.innerHTML = `<strong>${deal.name}</strong><br><small>${deal.desc}</small><br><small style="color:var(--warning)">Шанс: ${(deal.chance * 100)}% | ${costDisplay}</small>`;
                el.onclick = () => attemptShadyDeal(deal.name);
                container.appendChild(el);
            });
            showModal('shady-deals-modal');
        }

        function attemptShadyDeal(name) {
            const deal = shadyDeals.find(d => d.name === name);
            const cost = deal.cost < 0 ? 0 : deal.cost;

            if (gameState.money < cost) {
                showToast("У тебя нет денег на такую авантюру, нищеброд!", 'danger');
                return;
            }
            changeStat('money', -cost);
            changeStat('stress', deal.stress);

            if (Math.random() <= deal.chance) {
                const profit = deal.reward + (deal.cost < 0 ? Math.abs(deal.cost) : 0);
                changeStat('money', profit);
                showToast(`Афера удалась, красава! Ты поднял ${profit.toLocaleString()} ₽!`, 'success');
                audioSystem.play('cash');
                addEvent(`Ты провернул "${deal.name}" и сорвал куш. Серёга в ахуе.`);
                createUglyElement(); // Мем на удачу
            } else {
                changeStat('money', deal.penalty);
                showToast(`Тебя кинули, лох ебаный! Потеряно ${Math.abs(deal.penalty).toLocaleString()} ₽`, 'danger');
                audioSystem.play('lose');
                addEvent(`Схема "${deal.name}" провалилась. Ты в еще большей жопе, мудак.`);
            }
            hideModal('shady-deals-modal');
            updateUI();
            saveGame();
        }
        
        // --- Случайные события и конец игры ---
        function randomEvent() {
            const events = [
                () => { 
                    changeStat('money', 1000); 
                    showToast("Нашёл 1000 ₽ у ларька! Сегодня фартит, блядь.", 'success'); 
                    audioSystem.play('cash');
                },
                () => { 
                    if(gameState.money > 1500) { 
                        changeStat('money', -1500); 
                        showToast("Цыгане развели на 1500 ₽. Лох - это судьба, хули.", 'danger'); 
                        audioSystem.play('lose');
                    }
                },
                () => { 
                    changeStat('health', -15); 
                    showToast("Простудился под дождем, здоровье ухудшилось. Ебать, ты слабак.", 'warning'); 
                    addEvent("Заболела спина и жопа. Кажется, это простуда, пиздец.", 'warning');
                },
                () => { 
                    changeStat('stress', -20); 
                    showToast("По телеку показали 'Бригаду'. На душе стало тепло. Эх, времена...", 'success'); 
                    audioSystem.play('meme');
                },
                () => { 
                    if(gameState.money > 500) { 
                        changeStat('money', -500); 
                        showToast("Гопники отжали 500 ₽ 'на семки'. Пидоры.", 'danger'); 
                        addEvent("Нарвался на гоп-стоп. Легко отделался, повезло.", 'danger'); 
                        audioSystem.play('danger');
                    }
                },
                () => { 
                    changeStat('satiety', 20); 
                    showToast("Баба Нюра из подъезда угостила пирожками. Спасибо, ебать!", 'success'); 
                    audioSystem.play('eat');
                },
                () => { 
                    changeStat('stress', 10); 
                    showToast("Вспомнил, как Серёга смотрел на тебя. Ух, аж пропотел.", 'warning'); 
                } 
            ];
            events[Math.floor(Math.random() * events.length)]();
        }
        
        function creditorHarassment() {
            const threat = phrases.debtThreats[Math.floor(Math.random() * phrases.debtThreats.length)];
            showToast(threat, 'danger');
            changeStat('stress', 30);
            audioSystem.play('danger');
        }

        function checkGameOver() {
            if (gameState.gameOver) return;
            if (gameState.health <= 0) endGame("💀 СДОХ", phrases.gameOver.health);
            else if (gameState.stress >= 100) endGame("🤯 ПОЕХАЛ КУКУХОЙ", phrases.gameOver.stress);
            else if (gameState.day >= 30 && gameState.debt > 0) endGame("🔫 РАСПРАВА", phrases.gameOver.debt); 
            else if (gameState.debt <= 0) endGame("🎉 ПОБЕДА, БЛЯТЬ!", phrases.gameOver.win);
        }

        function endGame(title, text) {
            gameState.gameOver = true; saveGame(); haptic('error');
            document.getElementById('game-over-title').textContent = title;
            document.getElementById('game-over-text').textContent = text;
            if (title.includes("ПОБЕДА")) audioSystem.play('win');
            else audioSystem.play('lose');
            showModal('game-over-modal');
        }
        
        function restartGame() {
            localStorage.removeItem('stepaGameState');
            initGame(true); 
            hideModal('game-over-modal');
        }

        // --- Сохранение и загрузка ---
        function saveGame() {
            localStorage.setItem('stepaGameState', JSON.stringify(gameState));
        }

        function loadGame() {
            const savedState = localStorage.getItem('stepaGameState');
            if (savedState) {
                gameState = JSON.parse(savedState);
                if (!gameState.friends || !gameState.job) {
                    gameState = JSON.parse(JSON.stringify(initialGameState));
                }
                if (gameState.gameOver) {
                    // Если загружена проигранная игра, которая была сброшена, просто начинаем
                }
            } else {
                gameState = JSON.parse(JSON.stringify(initialGameState));
            }
        }

        // --- Инициализация ---
        function initGame(forceWelcome = false) {
            loadGame();
            
            // Показать приветственный экран только при первом запуске (день 1) или принудительном рестарте
            if (gameState.day === 1 || forceWelcome) {
              addEvent("Проснулся с бодуна. Кажется, я кому-то должен... Пиздец.", "warning");
              ui.welcomeModal.classList.add('show');
            } else if (gameState.gameOver) {
              // Если загружена проигранная игра, которая была сброшена, просто начинаем
            }

            updateUI();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // Обработчик для haptic feedback 
            document.querySelectorAll('.action-btn, .modal-close, .option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    haptic('light');
                });
            });
            initGame();
        });
    </script>
</body>
</html>

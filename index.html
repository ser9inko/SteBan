<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–°—Ç–µ–ø–∞: –ñ–∏–∑–Ω—å –î–æ–ª–∂–Ω–∏–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- –¶–í–ï–¢–ê –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï (Neumorphism Glass UI) --- */
        :root {
            --bg-dark-soft: #1e1e24; /* –ú—è–≥–∫–∏–π —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω */
            --bg-light-soft: #f8f8fc; /* –ú—è–≥–∫–∏–π —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
            --primary: #00bcd4; /* –ì–æ–ª—É–±–æ–π (–ê–∫—Ü–µ–Ω—Ç) */
            --secondary: #ff3e6c; /* –†–æ–∑–æ–≤—ã–π (–û–ø–∞—Å–Ω–æ—Å—Ç—å/–î–µ–π—Å—Ç–≤–∏–µ) */
            --text-main: #2c2c34;
            --text-low: #6a6a70;
            --glass-light: rgba(255, 255, 255, 0.4);
            --glass-dark: rgba(255, 255, 255, 0.1);
            --success: #4caf50;
            --danger: #ff4757;
            --warning: #ff9800;
        }
        
        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –ò –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        body {
            background: linear-gradient(160deg, var(--bg-light-soft) 0%, #e0e0e4 100%);
            color: var(--text-main);
            min-height: 100vh;
            min-height: 100dvh;
            padding: 10px;
            overflow-x: hidden;
            touch-action: manipulation;
            font-size: clamp(14px, 3.8vw, 16px);
        }
        
        .container { max-width: 500px; margin: 0 auto; }
        
        /* --- GLASS CARD (–ú–∞—Ç–æ–≤–æ–µ —Å—Ç–µ–∫–ª–æ) --- */
        .card {
            background: var(--glass-light);
            padding: 18px;
            border-radius: 25px; 
            margin-bottom: 15px;
            /* –≠—Ñ—Ñ–µ–∫—Ç –º–∞—Ç–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞ */
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* --- –ó–ê–ì–û–õ–û–í–û–ö --- */
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.6rem, 7vw, 2rem);
            text-align: center;
            color: var(--primary);
            text-shadow: 0 2px 5px rgba(0, 188, 212, 0.3); 
            margin-bottom: 15px;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        /* --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í –®–ê–ü–ö–ï --- */
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 12px 10px;
            border-radius: 18px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-low);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }
        
        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: clamp(1.3rem, 5.5vw, 1.6rem);
            color: var(--text-main);
            margin-top: 5px;
            word-break: break-word;
            display: block;
        }

        /* --- –ü–†–û–ì–†–ï–°–° –ë–ê–†–´ (Glass Card) --- */
        .progress-card { padding: 15px 20px; }
        .progress-container { 
            margin: 10px 0; 
            font-size: 0.9rem; 
            font-weight: 600; 
            display: flex; 
            flex-direction: column;
            gap: 4px;
        }
        .progress-label { display: flex; justify-content: space-between; align-items: center; }
        .progress-bar { 
            height: 14px;
            background: rgba(0, 0, 0, 0.1); /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å—Ç–µ–∫–ª–∞ */
            border-radius: 7px; 
            overflow: hidden; 
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        .progress-fill { 
            height: 100%; 
            transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
            border-radius: 7px;
        }
        /* –¶–≤–µ—Ç–∞ */
        #stress-bar .progress-fill { background: linear-gradient(90deg, #ffc107, var(--danger)); }
        #health-bar .progress-fill { background: linear-gradient(90deg, #7cfc00, var(--success)); }
        #satiety-bar .progress-fill { background: linear-gradient(90deg, var(--primary), #ffab00); }
        
        /* --- –ü–ï–†–°–û–ù–ê–ñ: –°–¢–ï–ü–ê --- */
        .character-container {
            text-align: center;
            margin: 20px 0;
            font-size: clamp(6rem, 25vw, 8rem);
            perspective: 1000px;
        }

        /* --- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô (Glass Buttons) --- */
        .actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .action-btn {
            padding: 10px 5px;
            border: none;
            border-radius: 20px;
            background: var(--glass-light);
            color: var(--text-main);
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 95px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            line-height: 1.1;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .action-btn i { 
            font-size: clamp(1.6rem, 4.5vw, 2rem); 
            color: var(--primary); 
            transition: color 0.2s ease, transform 0.2s ease; 
        }
        .action-btn:not(:disabled):hover { 
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-2px); 
        }
        .action-btn:not(:disabled):active { 
            transform: scale(0.96); 
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º */
        .action-btn.pay, .action-btn.escape {
            grid-column: span 3;
            color: white;
            font-size: 1rem;
            min-height: 50px;
            flex-direction: row;
            gap: 10px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        .action-btn.pay { background: linear-gradient(45deg, var(--success) 0%, #7cfc00 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
        .action-btn.escape { background: linear-gradient(45deg, #a700ff 0%, var(--secondary) 100%); box-shadow: 0 4px 15px rgba(167, 0, 255, 0.4); }
        .action-btn.pay i, .action-btn.escape i { color: white; }

        /* --- –õ–û–ì –°–û–ë–´–¢–ò–ô --- */
        .events {
            max-height: 250px;
            overflow-y: auto;
            font-size: 0.85rem;
            padding-right: 5px;
            background: rgba(0, 0, 0, 0.05); /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
        }
        .events::-webkit-scrollbar { width: 5px; }
        .events::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        .event { 
            padding: 10px; 
            margin-bottom: 8px; 
            border-radius: 15px; 
            background: rgba(255, 255, 255, 0.8);
            border-left: 6px solid var(--primary); 
            animation: slideIn 0.4s ease-out; 
            display: flex;
            gap: 10px;
            align-items: flex-start;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .event-icon { font-size: 1.2rem; color: var(--primary); margin-top: 1px; }
        .event.success { border-left-color: var(--success); }
        .event.success .event-icon { color: var(--success); }
        .event.danger { border-left-color: var(--danger); }
        .event.danger .event-icon { color: var(--danger); }
        .event.warning { border-left-color: var(--warning); }
        .event.warning .event-icon { color: var(--warning); }
        
        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (Full Glass) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: none; justify-content: center; align-items: center; z-index: 1000; padding: 10px; 
            opacity: 0; transition: opacity 0.4s ease;
        }
        .modal.show { display: flex; opacity: 1; }
        
        .modal-content {
            background: var(--glass-light);
            padding: 30px; border-radius: 30px; max-width: 95%; width: 450px;
            max-height: 95vh; overflow-y: auto; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9); transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }
        .modal.show .modal-content { transform: scale(1); }
        
        /* --- –û–ü–¶–ò–ò –í –ú–û–î–ê–õ–ö–ê–• --- */
        .option {
            background: rgba(255, 255, 255, 0.7);
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column;
            border-left: 5px solid var(--primary);
        }
        .option:hover { 
            background: rgba(255, 255, 255, 0.9); 
            transform: translateY(-1px);
        }
        .option strong { color: var(--text-main); font-size: 1.1rem; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .option small { line-height: 1.3; color: var(--text-low); }

        .option button { 
            background-color: var(--primary); color: white; border: none; border-radius: 15px; padding: 12px 20px; 
            cursor: pointer; margin-top: 15px; align-self: flex-end; font-size: 1rem; font-weight: bold;
            transition: background 0.2s ease, transform 0.1s ease; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
        }
        .option button.repay { background-color: var(--success); }
        .option button:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal-close {
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 15px;
            width: 100%;
            margin-top: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s ease;
            box-shadow: 0 5px 10px rgba(255, 62, 108, 0.4);
        }
        .modal-close:hover { background: #ff5c81; }
        
        /* --- –¢–û–°–¢–´ --- */
        .toast {
            background: linear-gradient(135deg, var(--primary), #00e5ff);
            color: white;
            padding: 15px 20px; 
            border-radius: 20px; 
            font-size: 0.95rem; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); 
            animation: fadeInOut 5s ease-in-out forwards;
            font-weight: 500;
        }
        .toast.success { background: linear-gradient(135deg, var(--success), #96ff8a); }
        .toast.danger { background: linear-gradient(135deg, var(--danger), #ff8a80); }
        .toast.warning { background: linear-gradient(135deg, var(--warning), #ffd54f); }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        @keyframes idle-bob { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(-1deg); } }
        @keyframes danger-shake { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 10%, 30%, 50%, 70%, 90% { transform: translate(-8px, 0) rotate(-4deg); } 20%, 40%, 60%, 80% { transform: translate(8px, 0) rotate(4deg); } }
        @keyframes heart-beat { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; transform: scale(1.02);} }
        @keyframes doge-vibe { 0%, 100% { transform: rotateY(0deg); } 50% { transform: rotateY(20deg); } }
        @keyframes flash-green { 0%, 100% { color: var(--text-main); } 50% { color: var(--success); transform: scale(1.05); text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);} }
        @keyframes flash-red { 0%, 100% { color: var(--text-main); } 50% { color: var(--danger); transform: scale(1.05); text-shadow: 0 0 5px rgba(255, 71, 87, 0.5);} }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-30px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }

        /* –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –∫ –∫–ª–∞—Å—Å–∞–º */
        .flash-green { animation: flash-green 0.7s ease-out; }
        .flash-red { animation: flash-red 0.7s ease-out; }
        .dizzy { animation: danger-shake 0.3s infinite; }
        .steep-anim { animation: doge-vibe 1.5s ease-in-out; }
        .stress-warning { animation: danger-shake 1s infinite; }

    </style>
</head>
<body>
    <div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 90%; max-width: 450px;"></div>
    
    <audio id="sound-money" src="https://assets.mixkit.co/sfx/download/mixkit-game-quick-positive-notification-202.wav" preload="auto"></audio> 
    <audio id="sound-fail" src="https://assets.mixkit.co/sfx/download/mixkit-app-error-2183.wav" preload="auto"></audio> 
    <audio id="sound-threat" src="https://assets.mixkit.co/sfx/download/mixkit-thunder-strike-456.wav" preload="auto"></audio> 
    <audio id="sound-success" src="https://assets.mixkit.co/sfx/download/mixkit-game-magic-sweep-2412.wav" preload="auto"></audio> 
    <audio id="sound-gameover" src="https://assets.mixkit.co/sfx/download/mixkit-retro-arcade-game-over-470.wav" preload="auto"></audio> 
    <audio id="sound-win" src="https://assets.mixkit.co/sfx/download/mixkit-game-success-alert-2005.wav" preload="auto"></audio> 

    <div id="welcome-modal" class="modal show">
        <div class="modal-content welcome-screen card">
            <h3 style="color:var(--secondary); text-align: center; font-size: 1.4rem; font-family: 'Orbitron';">üö® –°–¢–ï–ü–ê: –ñ–ò–ó–ù–¨ –î–û–õ–ñ–ù–ò–ö–ê üö®</h3>
            <hr style="margin: 15px 0; border: none; height: 1px; background: rgba(0,0,0,0.1);"/>
            <p style="font-style: italic; color: var(--text-low); margin-bottom: 20px;">–¢—ã –≤–∑—è–ª –∫—Ä–µ–¥–∏—Ç –Ω–∞ 100–∫. –î–æ–ª–≥ –≤—ã–∫—É–ø–∏–ª **–ö—Ä–µ–¥–∏—Ç–æ—Ä –ó–ª–æ–π**, –∏ —Ç–µ–ø–µ—Ä—å –æ–Ω –∑–Ω–∞–µ—Ç —Ç–≤–æ–π –∞–¥—Ä–µ—Å –≤ –ö—É—Ä—Å–∫–µ.</p>
            <p style="font-weight: bold; color: var(--primary);">–¢–≤–æ—è —Ü–µ–ª—å:</p>
            <ul style="margin-left: 15px; list-style-type: 'üëâ '; color: var(--text-main);">
                <li>–í–µ—Ä–Ω—É—Ç—å –¥–æ–ª–≥: **100 000 ‚ÇΩ** –ö—Ä–µ–¥–∏—Ç–æ—Ä—É –ó–ª–æ–º—É. –°—Ä–æ–∫: <span id="welcome-days">30</span> –¥–Ω–µ–π.</li>
                <li>–ò–ª–∏ —Å–≤–∞–ª–∏—Ç—å –≤ –†–æ—Å—Ç–æ–≤ –∑–∞ <span id="welcome-escape">65 000</span> ‚ÇΩ, –ø–æ–∫–∞ –Ω–µ —Å–ª–æ–º–∞–ª –∫–æ–ª–µ–Ω–∏.</li>
            </ul>
            <p style="margin-top: 20px; font-weight: bold; color: var(--danger);">–ü–†–ê–í–ò–õ–ê (–°–ª–µ–¥–∏ –∑–∞ —à–∫–∞–ª–∞–º–∏):</p>
            <ul style="color: var(--text-dark); margin-left: 15px; list-style-type: 'üî• ';">
                <li>**–ó–¥–æ—Ä–æ–≤—å–µ 0:** –ü–∏–∑–¥–µ—Ü. –¢—ã —Å–¥–æ—Ö.</li>
                <li>**–°—Ç—Ä–µ—Å—Å 100:** –î—É–±–æ–≤–∞—è –ø–∞–ª–∞—Ç–∞. –ö—É–∫—É—Ö–∞ –ø–æ–µ—Ö–∞–ª–∞.</li>
                <li>**–°—ã—Ç–æ—Å—Ç—å 0:** –ì–æ–ª–æ–¥–Ω–∞—è —Å–º–µ—Ä—Ç—å.</li>
            </ul>
            <button class="modal-close" style="background: var(--primary);" onclick="hideModal('welcome-modal')">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
        </div>
    </div>

    <div class="container">
        <div class="header card">
            <h1>–°–¢–ï–ü–ê: –ñ–ò–ó–ù–¨ –î–û–õ–ñ–ù–ò–ö–ê</h1>
            <div class="stats">
                <div class="stat-item">–î–ï–ù–¨ (–ò–∑ 30)<br><span class="stat-value" id="day">1</span></div>
                <div class="stat-item">–ë–ê–ë–ö–ò<br><span class="stat-value" id="money">5000 ‚ÇΩ</span></div>
                <div class="stat-item">–î–û–õ–ì<br><span class="stat-value" id="debt">100000 ‚ÇΩ</span></div>
                <div class="stat-item">–†–ê–ë–û–¢–ê<br><span class="stat-value" id="job">–ë–æ–º–∂</span></div>
            </div>
        </div>
        
        <div class="progress-card card">
            <div class="progress-container">
                <div class="progress-label">–ó–¥–æ—Ä–æ–≤—å–µ üí™: <span id="health-value">100</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="health-bar" style="width: 100%;"></div></div>
            </div>
            <div class="progress-container">
                <div class="progress-label">–°—ã—Ç–æ—Å—Ç—å üå≠: <span id="satiety-value">100</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="satiety-bar" style="width: 100%;"></div></div>
            </div>
            <div class="progress-container" id="stress-progress">
                <div class="progress-label">–°—Ç—Ä–µ—Å—Å ü§Ø: <span id="stress-value">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="stress-bar" style="width: 0%;"></div></div>
            </div>
        </div>
        
        <div class="character-container"><span id="stepa-emoji" style="animation: idle-bob 4s ease-in-out infinite;">üòê</span></div>
        
        <div class="actions">
            <button class="action-btn" onclick="work()"><i class="fa-solid fa-person-digging"></i>–†–∞–±–æ—Ç–∞—Ç—å</button>
            <button class="action-btn" onclick="showFoodModal()"><i class="fa-solid fa-burger"></i>–ü–æ–∂—Ä–∞—Ç—å</button>
            <button class="action-btn" onclick="showFriendsModal()"><i class="fa-solid fa-handshake"></i>–ö–µ–Ω—Ç—ã</button>
            <button class="action-btn" onclick="relieveStress()"><i class="fa-solid fa-martini-glass-citrus"></i>–ó–∞–±—É—Ö–∞—Ç—å</button>
            <button class="action-btn" onclick="showShadyDealsModal()"><i class="fa-solid fa-bolt-lightning"></i>–ú—É—Ç–Ω—ã–µ —Å—Ö–µ–º—ã</button>
            <button class="action-btn" onclick="findJob()"><i class="fa-solid fa-briefcase"></i>–ù–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É</button>
            <button class="action-btn" onclick="showUpgradeModal()"><i class="fa-solid fa-graduation-cap"></i>–ü—Ä–æ–∫–∞—á–∞—Ç—å –Ω–∞–≤—ã–∫–∏</button>
            <button class="action-btn pay" onclick="payDebt()"><i class="fa-solid fa-money-bill-transfer"></i>–û—Ç–¥–∞—Ç—å –¥–æ–ª–≥</button>
            <button class="action-btn escape" onclick="attemptEscape()"><i class="fa-solid fa-plane-departure"></i>–°–≤–∞–ª–∏—Ç—å –Ω–∞—Ö—É–π</button>
        </div>
        
        <div class="events card" id="events"></div>
    </div>
    
    <div id="friends-modal" class="modal"><div class="modal-content card"><h3>üë• –ö–µ–Ω—Ç—ã (–í–µ—Ä–Ω–∏, —Å—É–∫–∞)</h3><div id="friends-options"></div><button class="modal-close" onclick="hideModal('friends-modal')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>
    <div id="food-modal" class="modal"><div class="modal-content card"><h3>üçî –ü–æ–∂—Ä–∞—Ç—å (–ó–∞—Ç–∫–Ω—É—Ç—å –µ–±–∞–ª–æ)</h3><div id="food-options"></div><button class="modal-close" onclick="hideModal('food-modal')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>
    <div id="shady-deals-modal" class="modal"><div class="modal-content card"><h3>üòà –ú—É—Ç–Ω—ã–µ —Å—Ö–µ–º—ã (–ù–∞–µ–±–∞—Ç—å —Å—É–¥—å–±—É)</h3><div id="shady-deals-options"></div><button class="modal-close" onclick="hideModal('shady-deals-modal')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>
    <div id="upgrade-modal" class="modal"><div class="modal-content card"><h3>üß† –ü—Ä–æ–∫–∞—á–∞—Ç—å –ù–∞–≤—ã–∫–∏ (–°–∫–∏–ª–ª—ã)</h3><div id="upgrade-options"></div><button class="modal-close" onclick="hideModal('upgrade-modal')">–ó–∞–∫—Ä—ã—Ç—å</button></div></div>
    
    <div id="game-over-modal" class="modal">
        <div class="modal-content game-over card" style="border: 2px solid var(--danger);">
            <h2 id="game-over-title" style="color:var(--danger); font-size: 2.2rem; margin-bottom: 20px; text-align: center; font-family: 'Orbitron';"></h2>
            <p id="game-over-text" style="font-size: 1.1rem; line-height: 1.5; text-align: center; color: var(--text-main);"></p>
            <button class="modal-close" onclick="restartGame()" style="background: var(--danger);">–ù–∞—á–∞—Ç—å —ç—Ç—É —Ö—É–π–Ω—é –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg) { 
            tg.expand();
            tg.enableClosingConfirmation();
        }

        // --- –ê–£–î–ò–û–°–ò–°–¢–ï–ú–ê ---
        const audioSystem = {
            money: document.getElementById('sound-money'), fail: document.getElementById('sound-fail'),
            threat: document.getElementById('sound-threat'), success: document.getElementById('sound-success'),
            gameover: document.getElementById('sound-gameover'), win: document.getElementById('sound-win'),
            play: function(sound) {
                const audio = this[sound];
                if (audio && audio.src) {
                    const clone = audio.cloneNode(); clone.volume = 0.4; clone.currentTime = 0;
                    clone.play().catch(e => console.log("Audio playback failed:", e));
                }
            }
        };

        // --- –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ (Haptic Feedback) ---
        function haptic(type) {
            if (!tg || !tg.HapticFeedback) return;
            try {
                const styles = { error: 'error', success: 'success', warning: 'warning', light: 'light', medium: 'medium', heavy: 'heavy' };
                const hapticType = styles[type] || 'light';
                if(['error', 'success', 'warning'].includes(hapticType)) tg.HapticFeedback.notificationOccurred(hapticType);
                else tg.HapticFeedback.impactOccurred(hapticType);
            } catch (e) { console.log("Haptic failed:", e); }
        }
        
        // --- –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
        const initialGameState = {
            day: 1, maxDays: 30, money: 5000, debt: 100000, health: 100, satiety: 100, stress: 0,
            creditor: "–ö—Ä–µ–¥–∏—Ç–æ—Ä –ó–ª–æ–π", 
            job: { name: "–ë–æ–º–∂", salary: 750, stress: 5, health: -5, satiety: -15, isHomeless: true },
            skills: { health: 0, stress: 0, friends: 0 },
            friends: [
                { name: "–í–∞—Å—è–Ω", desc: "–°—Ç–∞—Ä—ã–π –¥—Ä—É–≥, –Ω–æ —Å–∞–º –≤ –∂–æ–ø–µ", maxLoan: 5000, chance: 0.6, debtAmount: 0 },
                { name: "–ü–µ—Ç—Ä—É—Ö–∞", desc: "–ñ–∞–¥–Ω—ã–π, —Å—á–∏—Ç–∞–µ—Ç –∫–æ–ø–µ–π–∫–∏", maxLoan: 3000, chance: 0.3, debtAmount: 0 },
                { name: "–°–µ–º—ë–Ω—ã—á", desc: "–î—É—à–∞-–ø–∞—Ä–µ–Ω—å, –ø–æ–¥ –∫–∞–±–ª—É–∫–æ–º", maxLoan: 7000, chance: 0.7, debtAmount: 0 },
                { name: "–ì—Ä–∏—à–∞ –ö–∞–±–∞–Ω", desc: "–ë—Ä–∞—Ç–æ–∫, –¥–∞—Å—Ç –ø–æ–¥ –ª—é—Ç—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç (–í–µ—Ä–Ω—É—Ç—å 150%)", maxLoan: 10000, chance: 0.85, repayment: 15000, debtAmount: 0 },
                { name: "–õ–µ—Ö–∞ –ú—É—Ç–Ω—ã–π", desc: "–î–∞—Å—Ç 30–∫, –Ω–æ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –≤ 50–∫", maxLoan: 30000, chance: 0.5, repayment: 50000, debtAmount: 0 }
            ],
            gameOver: false,
        };
        let gameState;

        // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ ---
        const ESCAPE_COST = 65000;
        const food = [
            { name: "–ë—É—Ç—ã–ª–∫–∞ –∫–µ—Ñ–∏—Ä–∞ (–ü–æ–º–æ–≥–∞–µ—Ç)", cost: 50, satiety: 10, health: 0, stress: 0, icon: 'fa-bottle-water' },
            { name: "–î–æ—à–∏—Ä–∞–∫ —Å –º–∞–∑–∏–∫–æ–º (–û–≥–æ–Ω—å)", cost: 100, satiety: 25, health: -2, stress: 5, icon: 'fa-bowl-food' },
            { name: "–®–∞—É—Ä–º–∞ –ü—Ä–æ–Ω–µ—Å–∏, –ì–æ—Å–ø–æ–¥–∏", cost: 250, satiety: 40, health: 5, stress: 0, icon: 'fa-sandwich' },
            { name: "–ë–∏–∑–Ω–µ—Å-–ª–∞–Ω—á –ö–∞–∫ –ß–µ–ª–æ–≤–µ–∫", cost: 600, satiety: 65, health: 10, stress: -10, icon: 'fa-utensils' },
            { name: "–§–æ—Ä–µ–ª—å –≤ –ö—É—Ä—Å–∫–æ–º –¥–≤–æ—Ä–∏–∫–µ", cost: 3000, satiety: 100, health: 5, stress: -30, icon: 'fa-fish-fins' } 
        ];
        const jobs = [
            { name: "–ì—Ä—É–∑—á–∏–∫ (–µ–±–∞–Ω—ã–π)", salary: 1500, stress: 15, health: -10, satiety: -20, isHomeless: false },
            { name: "–ö—É—Ä—å–µ—Ä –Ω–∞ –≤–µ–ª–∏–∫–µ", salary: 2000, stress: 10, health: -5, satiety: -25, isHomeless: false },
            { name: "–û—Ö—Ä–∞–Ω–Ω–∏–∫ –≤ –ü—è—Ç–µ—Ä–æ—á–∫–µ", salary: 2500, stress: 5, health: 0, satiety: -10, isHomeless: false },
            { name: "–¢–∞–∫—Å–∏—Å—Ç –í–µ—Ç–µ—Ä–æ–∫", salary: 3500, stress: 20, health: -5, satiety: -15, isHomeless: false },
            { name: "–ü–æ–º–æ—â–Ω–∏–∫ –¥–µ–ø—É—Ç–∞—Ç–∞ (–ú—É—Ç–∫–∞)", salary: 5000, stress: 10, health: 5, satiety: -5, isHomeless: false }
        ];
        const shadyDeals = [
            { name: "–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –†—ã–∂–µ–≥–æ (–î–µ—Ä–±–∏)", desc: "–°–æ–±–∞—á—å–∏ –±–æ–∏. –í–µ—Ä–Ω—è–∫. –°—Ç–∞–≤–∫–∞ - 1–∫. –ú–µ–º: **–í–ñ–£–•!**", cost: 1000, reward: 5000, chance: 0.4, penalty: -1000, stress: 20, icon: 'fa-dog' },
            { name: "–ü–µ—Ä–µ–≤–µ–∑—Ç–∏ –¥–∏–≤–∞–Ω (–ö–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞)", desc: "–í 3 —á–∞—Å–∞ –Ω–æ—á–∏. –í–æ–ø—Ä–æ—Å—ã –ª—É—á—à–µ –Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å. –ú–µ–º: **–≠–¢–û –†–û–°–°–ò–Ø**.", cost: 0, reward: 8000, chance: 0.6, penalty: -5000, stress: 30, icon: 'fa-truck-moving' },
            { name: "–ü—Ä–æ–¥–∞—Ç—å –≤–∏—Ç–∞–º–∏–Ω—ã —É –∫–ª—É–±–∞", desc: "–ö–∞–∫–æ–π-—Ç–æ –ø–æ—Ä–æ—à–æ–∫. –ü—Ä–æ—Ñ–∏—Ç: 10–∫, –µ—Å–ª–∏ –º—É—Å–æ—Ä–∞ –Ω–µ –ø—Ä–∏–º—É—Ç. –ú–µ–º: **–ü–ê–ù–ò–ö–ê**.", cost: -2000, reward: 10000, chance: 0.3, penalty: -10000, stress: 50, icon: 'fa-capsules' },
            { name: "–í–∑–ª–æ–º–∞—Ç—å –∏–≥—Ä–æ–≤—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã", desc: "–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: God Mode. –ï—Å–ª–∏ –ø—Ä–æ–∫–∞—Ç–∏—Ç ‚Äî 20–∫. –ú–µ–º: **–£–î–ê–ß–ê**.", cost: 5000, reward: 20000, chance: 0.15, penalty: -15000, stress: 40, icon: 'fa-slot-machine' },
            { name: "–°–¥–∞—Ç—å –ö—Ä–µ–¥–∏—Ç–æ—Ä—É –ó–ª–æ–º—É –õ—ë—Ö—É", desc: "–ü—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∑–∞ 15–∫. –£–¥–∞—Ä –ø–æ –∑–¥–æ—Ä–æ–≤—å—é. –ú–µ–º: **–ö–†–´–°–ê**.", cost: 0, reward: 15000, chance: 0.9, penalty: 0, stress: 50, health: -15, icon: 'fa-user-secret' }
        ];
        const UPGRADES = [
            { id: 'health', name: '–ù–∞–≤—ã–∫ –í—ã–∂–∏–≤–∞–Ω–∏—è (–ó–¥–æ—Ä–æ–≤—å–µ)', icon: 'fa-heart-pulse', cost: 10000, bonus: 10, limit: 5, desc: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ç–≤–æ—é –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç—å. **+10 –∫ –±–∞–∑–æ–≤–æ–º—É –ó–¥–æ—Ä–æ–≤—å—é.**" },
            { id: 'stress', name: '–ù–∞–≤—ã–∫ –î–∑–µ–Ω (–°—Ç—Ä–µ—Å—Å)', icon: 'fa-brain', cost: 15000, bonus: 0.05, limit: 3, desc: "–£–º–µ–Ω—å—à–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç —Å—Ç—Ä–µ—Å—Å–∞. **-5% –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞.**" },
            { id: 'friends', name: '–ù–∞–≤—ã–∫ –£–±–µ–∂–¥–µ–Ω–∏—è (–ö–µ–Ω—Ç—ã)', icon: 'fa-users-line', cost: 20000, bonus: 0.15, limit: 2, desc: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —à–∞–Ω—Å, —á—Ç–æ –∫–µ–Ω—Ç—ã –¥–∞–¥—É—Ç –≤ –¥–æ–ª–≥. **+15% –∫ —à–∞–Ω—Å—É.**" },
        ];
        const phrases = {
            work: ["–í—ä–µ–±—ã–≤–∞–ª –∫–∞–∫ —Ä–∞–± –Ω–∞ –≥–∞–ª–µ—Ä–∞—Ö. –ó–∞—Ä–∞–±–æ—Ç–∞–ª.", "–ì–æ—Ä–±–∞—Ç–∏–ª—Å—è –∑–∞ –≥—Ä–æ—à–∏, –ø—Ä–æ–∫–ª–∏–Ω–∞—è –≤—Å—ë –Ω–∞ —Å–≤–µ—Ç–µ.", "–ü—Ä–æ–¥–∞–ª –µ—â–µ –æ–¥–∏–Ω –¥–µ–Ω—å –∂–∏–∑–Ω–∏ –∑–∞ –µ–±—É—á–∏–µ –∫–æ–ø–µ–π–∫–∏.", "–ò–º–∏—Ç–∏—Ä–æ–≤–∞–ª –±—É—Ä–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∑–∞–µ–±–∞–ª—Å—è, –Ω–æ –¥–µ–Ω—å–≥–∏ –ø–æ–ª—É—á–∏–ª."],
            debtThreats: [
                "üìû –ö—Ä–µ–¥–∏—Ç–æ—Ä –ó–ª–æ–π: –°–ª—ã—à—å, —É–µ–±–∞–Ω, –±–∞–±–∫–∏ –≥–¥–µ? –Ø —Ç–≤–æ–π –¥–æ–º —Ç—Ä—É–±–∞ —à–∞—Ç–∞–ª! **BRUH!**", 
                "SMS –æ—Ç –ó–ª–æ–≥–æ: –¢–≤–æ–∏ –ø–æ—á–∫–∏ —Å—Ç–æ—è—Ç 100–∫. –£ —Ç–µ–±—è –µ—Å—Ç—å –≤—ã–±–æ—Ä, —Å—É–∫–∞. **–î–ï–õ–ê–ô –í–´–ë–û–†**.", 
                "SMS –æ—Ç –ó–ª–æ–≥–æ: –Ø –∑–Ω–∞—é –≥–¥–µ –∂–∏–≤–µ—Ç —Ç–≤–æ—è –ü—Ä–∏–æ—Ä–∞. –í—Ä–µ–º—è –ø–æ—à–ª–æ. –ü–∏–∑–¥–µ—Ü. **–ó–ê–í–¢–†–ê –í–´–ï–ó–î**."
            ],
            friendReject: ["–ø–æ—Å–ª–∞–ª —Ç–µ–±—è –Ω–∞—Ö—É–π.", "—Å–∫–∞–∑–∞–ª, —á—Ç–æ –µ–≥–æ –∂–µ–Ω–∞ –ø—Ä–æ—Ç–∏–≤. –¢—Ä—è–ø–∫–∞.", "—Å–¥–µ–ª–∞–ª –≤–∏–¥, —á—Ç–æ –Ω–µ —É–∑–Ω–∞–ª —Ç–µ–±—è, –ø–∏–¥–æ—Ä–∞.", "—Å–∫–∞–∑–∞–ª, –¥–æ–ª–≥ –ø–ª–∞—Ç–µ–∂–æ–º –∫—Ä–∞—Å–µ–Ω –∏ —Å—ä–µ–±–∞–ª—Å—è –≤ –∑–∞–∫–∞—Ç."],
            gameOver: {
                health: "–¢—ã —Å–¥–æ—Ö –æ—Ç –∫–∞–∫–æ–π-–¢–û —Ö—É–π–Ω–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ —Å–ª–µ–¥–∏–ª –∑–∞ –∑–¥–æ—Ä–æ–≤—å–µ–º, –º—É–¥–∞–∫. –¢–≤–æ–∏ –¥–æ–ª–≥–∏ –ø–µ—Ä–µ—à–ª–∏ –∫–æ—Ç—É. –ú—è—É. **RIP –°—Ç–µ–ø–∞** üòø",
                stress: "–¢–≤–æ—è –∫—É–∫—É—Ö–∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–ª–µ—Ç–µ–ª–∞. –û—Å—Ç–∞—Ç–æ–∫ –∂–∏–∑–Ω–∏ —Ç—ã –ø—Ä–æ–≤–µ–¥–µ—à—å, –ø—É—Å–∫–∞—è —Å–ª—é–Ω–∏ –≤ –¥—É—Ä–∫–µ –∏ –∫—Ä–∏—á–∞ **'–ì–î–ï –î–ï–ù–¨–ì–ò, –õ–ï–ë–û–í–°–ö–ò?'**. –ï–±–∞—Ç—å, –ø–æ–∑–æ—Ä–∏—â–µ. ü§°",
                debt: "–¢–µ—Ä–ø–µ–Ω–∏–µ –ö—Ä–µ–¥–∏—Ç–æ—Ä–∞ –ó–ª–æ–≥–æ –ª–æ–ø–Ω—É–ª–æ. –¢–µ–±—è –≤—ã–≤–µ–∑–ª–∏ –≤ –ª–µ—Å –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ –æ–±—å—è—Å–Ω–∏–ª–∏, —á—Ç–æ —Ç–∞–∫ –¥–µ–ª–∞—Ç—å –Ω–µ–ª—å–∑—è. –¢–≤–æ–∏ –æ—Å—Ç–∞–Ω–∫–∏ –¥–æ —Å–∏—Ö –ø–æ—Ä –∏—â—É—Ç, –ª–æ–ª. **FINISH HIM** üî™",
                win: "–ï–±–∞—Ç—å, —Ç—ã —Ä–µ–∞–ª—å–Ω–æ —Å–º–æ–≥! –û—Ç–¥–∞–ª –≤—Å–µ –¥–æ–ª–≥–∏ –ö—Ä–µ–¥–∏—Ç–æ—Ä—É –ó–ª–æ–º—É. –¢–µ–ø–µ—Ä—å —Ç—ã –ª–µ–≥–µ–Ω–¥–∞ –ö—É—Ä—Å–∫–∞. –ú–æ–∂–µ—à—å —Å—ä–µ–±–∞—Ç—å –æ—Ç—Å—é–¥–∞ —Å —á–∏—Å—Ç–æ–π —Å–æ–≤–µ—Å—Ç—å—é, –∫—Ä–∞—Å–∞–≤–∞. **–ü–û–¢–†–ê–ß–ï–ù–û** üéâ",
                escape: "–¢—ã —Å–≤–∞–ª–∏–ª –∏–∑ –ö—É—Ä—Å–∫–∞ –≤ –†–æ—Å—Ç–æ–≤! –ö—Ä–µ–¥–∏—Ç–æ—Ä –ó–ª–æ–π –≤ –±–µ—à–µ–Ω—Å—Ç–≤–µ. –¢–µ–±—è –∏—â—É—Ç, –Ω–æ —Ç—ã –Ω–∞ —Å–≤–æ–±–æ–¥–µ! –ù–æ–≤–∞—è –∂–∏–∑–Ω—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —à–∞—É—Ä–º—ã –Ω–∞ –≤–æ–∫–∑–∞–ª–µ. –°–≤–æ–±–æ–¥–∞, –±–ª—è–¥—å! **FREEDOM** üïäÔ∏è"
            },
            relieveStress: ["–ü—Ä–æ—Å–∞–¥–∏–ª 1000 ‚ÇΩ –≤ –±–∞—Ä–µ. –°—Ç–∞–ª–æ –ª–µ–≥—á–µ, –Ω–æ –ø–µ—á–µ–Ω—å –ø–µ—Ä–µ–¥–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç. –•—É–ª–∏, –ø–æ—Ö—É–π. **–ó–ê –ó–î–û–†–û–í–¨–ï**", "–ë—É—Ç—ã–ª–∫–∞ –ø–∏–≤–∞ –∏ '–î–∞–≤–∞–π –ø–æ–∂–µ–Ω–∏–º—Å—è' - –∏–¥–µ–∞–ª—å–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è. -40 —Å—Ç—Ä–µ—Å—Å–∞. **–ñ–ò–ó–ê**"]
        };

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI ---
        const ui = {
            day: document.getElementById('day'), money: document.getElementById('money'), debt: document.getElementById('debt'), job: document.getElementById('job'),
            health: document.getElementById('health-value'), healthBar: document.getElementById('health-bar'),
            satiety: document.getElementById('satiety-value'), satietyBar: document.getElementById('satiety-bar'),
            stress: document.getElementById('stress-value'), stressBar: document.getElementById('stress-bar'),
            stressContainer: document.getElementById('stress-progress'),
            healthContainer: document.getElementById('health-bar').parentNode.parentNode,
            stepaEmoji: document.getElementById('stepa-emoji'), events: document.getElementById('events'), toastContainer: document.getElementById('toast-container'),
            welcomeModal: document.getElementById('welcome-modal'),
            actionButtons: document.querySelectorAll('.action-btn')
        };
        
        let statUpdateTimers = {};
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ø–∞–º–∞
        function disableActions(duration = 1000) {
            ui.actionButtons.forEach(btn => btn.disabled = true);
            setTimeout(() => {
                if (!gameState.gameOver) {
                    ui.actionButtons.forEach(btn => btn.disabled = false);
                }
            }, duration);
        }

        // –ü–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        function animateStatUpdate(element, newValue, key) {
            const oldValue = element.textContent;
            if (oldValue === String(newValue)) return;

            const oldNum = parseFloat(oldValue.replace(/[^\d.-]/g, '')) || 0;
            const newNum = parseFloat(String(newValue).replace(/[^\d.-]/g, '')) || 0;
            
            let changeClass = '';
            
            if (key === 'debt') {
                 if (newNum < oldNum) changeClass = 'flash-green';
                 if (newNum > oldNum) changeClass = 'flash-red';
            } else if (key === 'money') {
                if (newNum > oldNum) changeClass = 'flash-green';
                if (newNum < oldNum) changeClass = 'flash-red';
            } else if (key === 'day' || key === 'job') {
                changeClass = 'flash-green';
            }

            element.textContent = newValue;

            if (changeClass) {
                clearTimeout(statUpdateTimers[key]);
                element.classList.remove('flash-green', 'flash-red');
                void element.offsetWidth; 
                element.classList.add(changeClass);
                statUpdateTimers[key] = setTimeout(() => element.classList.remove(changeClass), 800);
            }
        }
        
        function updateUI() {
            // –ê–Ω–∏–º–∞—Ü–∏—è –¥–µ–Ω–µ–≥ –∏ –¥–æ–ª–≥–∞
            animateStatUpdate(ui.day, `${gameState.day} (–ò–∑ ${gameState.maxDays})`, 'day');
            animateStatUpdate(ui.money, gameState.money.toLocaleString('ru-RU') + ' ‚ÇΩ', 'money');
            animateStatUpdate(ui.debt, gameState.debt.toLocaleString('ru-RU') + ' ‚ÇΩ', 'debt');
            animateStatUpdate(ui.job, gameState.job.name, 'job');
            
            // –†–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è/—Å—Ç—Ä–µ—Å—Å–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫–∞—á–∫–∏
            const maxHealth = 100 + gameState.skills.health * 10;
            const maxStress = 100;
            
            const healthPercent = (gameState.health / maxHealth) * 100;
            const stressPercent = (gameState.stress / maxStress) * 100;

            // –ü–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∫–∞–ª
            ui.health.textContent = `${gameState.health} / ${maxHealth}`; ui.healthBar.style.width = `${healthPercent}%`;
            ui.satiety.textContent = gameState.satiety; ui.satietyBar.style.width = `${gameState.satiety}%`;
            ui.stress.textContent = gameState.stress; ui.stressBar.style.width = `${stressPercent}%`;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
            ui.healthContainer.style.animation = healthPercent < 20 ? 'heart-beat 1.5s infinite' : 'none';
            ui.stressContainer.style.animation = stressPercent > 80 ? 'danger-shake 1s infinite' : 'none';

            updateStepaEmoji();
        }

        function changeStat(stat, value) {
            const maxHealth = 100 + gameState.skills.health * 10;
            
            const oldValue = gameState[stat];
            gameState[stat] = gameState[stat] + value;
            
            if (stat === 'health') gameState[stat] = Math.min(Math.max(0, gameState[stat]), maxHealth);
            else if (stat === 'satiety') gameState[stat] = Math.min(Math.max(0, gameState[stat]), 100);
            else if (stat === 'stress') gameState[stat] = Math.min(Math.max(0, gameState[stat]), 100);
            else if (stat === 'money' || stat === 'debt') gameState[stat] = Math.max(0, gameState[stat]);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —ç–º–æ—Ü–∏—é/–∞–Ω–∏–º–∞—Ü–∏—é –°—Ç–µ–ø—ã
            if (stat === 'health' && gameState.health < 30 && oldValue >= 30) {
                setStepaAnimation('danger-shake', 2);
            } else if (stat === 'stress' && gameState.stress > 70 && oldValue <= 70) {
                setStepaAnimation('danger-shake', 2);
            } else if (stat === 'money' && value > 5000) {
                setStepaAnimation('doge-vibe', 1.5);
            }
        }
        
        function setStepaAnimation(animation, duration) {
            const currentAnim = ui.stepaEmoji.style.animationName;
            if (currentAnim.includes('shake') || currentAnim.includes('vibe') || currentAnim.includes('dizzy')) return;

            ui.stepaEmoji.style.animation = 'none';
            void ui.stepaEmoji.offsetWidth; 
            ui.stepaEmoji.style.animation = `${animation} ${duration}s ease-in-out`;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
            setTimeout(() => {
                 ui.stepaEmoji.style.animation = 'idle-bob 4s ease-in-out infinite';
                 updateStepaEmoji();
            }, duration * 1000);
        }
        
        function updateStepaEmoji() {
            const currentAnim = ui.stepaEmoji.style.animationName;
            if (currentAnim !== 'idle-bob' && currentAnim !== 'none' && currentAnim !== '') return; 

            if (gameState.debt <= 0) ui.stepaEmoji.textContent = 'ü•≥'; 
            else if (gameState.stress >= 85) ui.stepaEmoji.textContent = 'ü§Ø';
            else if (gameState.health <= 20) ui.stepaEmoji.textContent = 'üíÄ';
            else if (gameState.satiety <= 20) ui.stepaEmoji.textContent = 'ü§¢';
            else if (gameState.money > 50000) ui.stepaEmoji.textContent = 'ü§ë';
            else if (gameState.money < 1000) ui.stepaEmoji.textContent = 'üò≠';
            else if (gameState.debt > gameState.money * 10 && gameState.day > 10) ui.stepaEmoji.textContent = 'üò±';
            else ui.stepaEmoji.textContent = 'üòê'; 
        }

        function addEvent(message, type = "default", icon = 'fa-circle-info') {
            const eventEl = document.createElement('div');
            eventEl.className = `event ${type}`;
            eventEl.innerHTML = `<i class="fa-solid ${icon} event-icon"></i> <span>–î–µ–Ω—å ${gameState.day}: ${message}</span>`;
            ui.events.prepend(eventEl);
            if(ui.events.children.length > 20) ui.events.lastChild.remove();
        }

        function showToast(message, type = "default") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            ui.toastContainer.appendChild(toast);
            
            const hapticMap = { danger: 'error', success: 'success', warning: 'warning', default: 'light' };
            if (hapticMap[type]) haptic(hapticMap[type]);
            
            setTimeout(() => toast.remove(), 5000); 
        }
        
        // --- –°–ú–ï–ù–ê –î–ù–Ø ---
        function nextDay() {
            if (gameState.gameOver) return;
            
            disableActions();

            changeStat('day', 1);
            
            // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –¥–µ–±–∞—Ñ—Ñ—ã (—Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫–∞—á–∫–∏ —Å—Ç—Ä–µ—Å—Å–∞)
            changeStat('satiety', -10);
            
            let debtStressBase = gameState.debt > 70000 ? 7 : (gameState.debt > 30000 ? 4 : 2);
            const stressUpgrade = UPGRADES.find(u => u.id === 'stress');
            debtStressBase = debtStressBase * (1 - gameState.skills.stress * stressUpgrade.bonus); 
            changeStat('stress', Math.max(1, Math.round(debtStressBase))); 

            if (gameState.satiety <= 0) {
                changeStat('health', -15);
                addEvent("–û—Ç –≥–æ–ª–æ–¥–∞ —Å–≤–æ–¥–∏—Ç –∂–∏–≤–æ—Ç. –¢–µ—Ä—è–µ—à—å –∑–¥–æ—Ä–æ–≤—å–µ, —Ö—É–∏–ª–∞. **–ù–ï –ö–û–†–ú–ò–õ–ò**.", "danger", 'fa-drumstick-bite');
                audioSystem.play('fail');
            }
            if(gameState.stress > 0) changeStat('stress', -3); // –ù–µ–±–æ–ª—å—à–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

            if (Math.random() < 0.3) randomEvent();
            if (gameState.day > 2 && gameState.day % 4 === 0 && gameState.debt > 0) creditorHarassment();

            updateUI();
            checkGameOver();
            saveGame();
        }
        
        // --- –î–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞ ---
        function work() {
            const { salary, stress, health, satiety, isHomeless } = gameState.job;
            let finalSalary = salary;
            let eventMsg = phrases.work[Math.floor(Math.random() * phrases.work.length)];
            let icon = 'fa-money-bill-wave';
            
            const rand = Math.random();

            if (rand < 0.1 && !isHomeless) { 
                finalSalary *= 1.5;
                eventMsg = "–ù–∞—á–∞–ª—å–Ω–∏–∫ –±—ã–ª –≤ –∑–∞–ø–æ–µ –∏ —Å–ª—É—á–∞–π–Ω–æ –≤—ã–ø–∏—Å–∞–ª –ø—Ä–µ–º–∏—é. –ü–æ–≤–µ–∑–ª–æ, —Ö—É–ª–∏. **DOGE VIBE**";
                showToast(`–ü—Ä–µ–º–∏—è, —Å—É–∫–∞! +${(finalSalary - salary).toLocaleString()} ‚ÇΩ`, 'success');
                audioSystem.play('money');
                icon = 'fa-sack-dollar';
            } else if (rand < 0.15) { 
                const fine = isHomeless ? 0 : 500; 
                if (gameState.money >= fine) { 
                     changeStat('money', -fine);
                     finalSalary = salary - fine;
                     showToast(`–®—Ç—Ä–∞—Ñ! –ú–∏–Ω—É—Å –±–∞–±–∫–∏, —É–µ–±–æ–∫. -${fine.toLocaleString()} ‚ÇΩ. **–û–ë–ò–î–ù–û**`, 'danger');
                     eventMsg = "–û–ø–æ–∑–¥–∞–ª –Ω–∞ —Å–º–µ–Ω—É, –ø–æ–ª—É—á–∏–ª —à—Ç—Ä–∞—Ñ. –ï–±–∞—Ç—å, —Ç—ã –ª–æ—Ö.";
                     audioSystem.play('fail');
                     icon = 'fa-hand-holding-dollar';
                } else {
                    eventMsg = "–ß—É–¥–æ–º –∏–∑–±–µ–∂–∞–ª —à—Ç—Ä–∞—Ñ–∞, –Ω–æ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ —Å–≤–µ—Ç–∏—Ç. **–ü–†–û–ù–ï–°–õ–û**";
                    finalSalary = 0;
                    icon = 'fa-user-slash';
                }
            } else if (isHomeless && rand < 0.3) {
                finalSalary += 200;
                eventMsg = "–ù–∞—à–µ–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –±—É—Ç—ã–ª–æ–∫ –∏ —Å–¥–∞–ª –∏—Ö. –ú–µ–ª–æ—á—å, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ, –±–æ–º–∂–∞—Ä–∞. **–ë–û–ú–ñ-–õ–ê–ô–§**";
                audioSystem.play('money');
            }

            changeStat('money', finalSalary);
            changeStat('stress', stress);
            changeStat('health', health);
            changeStat('satiety', satiety);

            haptic('medium');
            setStepaAnimation('doge-vibe', 1);
            addEvent(`${eventMsg} –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${finalSalary.toLocaleString()} ‚ÇΩ.`, (finalSalary > 0 ? 'success' : 'warning'), icon);
            
            nextDay(); 
        }

        function findJob() {
            if (!gameState.job.isHomeless && Math.random() > 0.6) {
                 showToast("–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å —Ä–∞–±–æ—Ç–∞, –º—É–¥–∏–ª–∞! –ù–µ —Ä—ã–ø–∞–π—Å—è. ü§®", 'warning');
                 changeStat('stress', 5);
                 updateUI(); saveGame();
                 return;
            }

            if (Math.random() > 0.4) {
                const newJob = jobs[Math.floor(Math.random() * jobs.length)];
                gameState.job = newJob;
                showToast(`–¢—ã –Ω–∞—à–µ–ª –Ω–æ–≤—É—é —Ä–∞–±–æ—Ç—É: ${newJob.name}! –ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ, –±–ª—è–¥—å! **–°–ß–ê–°–¢–¨–ï** üëç`, 'success');
                addEvent(`–ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Ç—ã –Ω–µ –±–æ–º–∂, –∞ ${newJob.name}. –ó–∞—Ä–ø–ª–∞—Ç–∞ ${newJob.salary.toLocaleString()} ‚ÇΩ/–¥–µ–Ω—å.`, 'success', 'fa-briefcase');
                audioSystem.play('success');
            } else {
                showToast("–ù–∏–∫–æ–º—É —Ç—ã –Ω–∞—Ö—É–π –Ω–µ –Ω—É–∂–µ–Ω, –Ω–µ—É–¥–∞—á–Ω–∏–∫. –ò—â–∏ –¥–∞–ª—å—à–µ. **–ù–ï –ü–û–í–ï–ó–õ–û** üí©", 'danger');
                changeStat('stress', 10);
                audioSystem.play('fail');
            }
            updateUI(); saveGame();
        }
        
        function relieveStress() {
            if (gameState.money < 1000) { showToast("–î–µ–Ω–µ–≥ –Ω–µ—Ç –¥–∞–∂–µ –Ω–∞ –±–æ—è—Ä—É, –∏–¥–∏ –Ω–∞—Ö—É–π!", "danger"); audioSystem.play('fail'); return; }
            if (gameState.stress < 10) { showToast("–ö–∞–∫–æ–π-—Ç–æ —Ç—ã –Ω–µ—Å—Ç—Ä–µ—Å—Å–æ–≤—ã–π —Å–µ–≥–æ–¥–Ω—è. –ü–æ—Ä–∞–±–æ—Ç–∞–π —Å–Ω–∞—á–∞–ª–∞. ü•±", "warning"); return; }
            
            changeStat('money', -1000); changeStat('stress', -40); changeStat('health', -5);
            haptic('medium');
            
            const eventIndex = Math.floor(Math.random() * phrases.relieveStress.length);
            const eventMsg = phrases.relieveStress[eventIndex];
            
            ui.stepaEmoji.textContent = (eventIndex === 0) ? 'ü•¥' : 'üòå';
            setStepaAnimation('dizzy', 2);
            addEvent(eventMsg, 'success', 'fa-cocktail');
            audioSystem.play('success');
            nextDay(); 
        }
        
        function payDebt() {
            const payment = Math.min(gameState.money, gameState.debt); 
            if (payment <= 0) { showToast(`–ù–µ—á–µ–º –ø–ª–∞—Ç–∏—Ç—å ${gameState.creditor}, —Ç—ã –Ω–∏—â–∏–π –∫—É—Å–æ–∫ –≥–æ–≤–Ω–∞! ü§°`, "danger"); audioSystem.play('fail'); return; }
            
            changeStat('money', -payment); 
            changeStat('debt', -payment); 
            changeStat('stress', -20);
            
            showToast(`–û—Ç–¥–∞–ª ${payment.toLocaleString()} ‚ÇΩ. ${gameState.creditor} —Å–µ–≥–æ–¥–Ω—è –Ω–µ –±—É–¥–µ—Ç –ª–æ–º–∞—Ç—å —Ç–µ–±–µ –Ω–æ–≥–∏. –ü–æ–∫–∞ —á—Ç–æ. **–ü–ê–¶–ê–ù –°–ö–ê–ó–ê–õ** üôè`, "success");
            audioSystem.play('money');
            addEvent(`–û—Ç–¥–∞–ª —á–∞—Å—Ç—å –¥–æ–ª–≥–∞: ${payment.toLocaleString()} ‚ÇΩ. –°—Ç–∞–ª–æ –ª–µ–≥—á–µ –¥—ã—à–∞—Ç—å. **–û–¢–õ–ï–ì–õ–û**`, 'success', 'fa-money-bill-transfer');
            updateUI(); checkGameOver(); saveGame();
        }

        function attemptEscape() {
            if (gameState.money < ESCAPE_COST) {
                showToast(`–î–ª—è –ø–æ–±–µ–≥–∞ –Ω—É–∂–Ω–æ ${ESCAPE_COST.toLocaleString()} ‚ÇΩ. –ò–¥–∏ —Ä–∞–±–æ—Ç–∞–π, –∫—Ä—ã—Å–∞! üêÄ`, "danger");
                audioSystem.play('fail');
                return;
            }

            // –®–∞–Ω—Å –Ω–∞ –ø—Ä–æ–≤–∞–ª
            if (gameState.debt > 50000 && Math.random() < 0.15) { 
                changeStat('money', -ESCAPE_COST / 2); 
                changeStat('stress', 50);
                showToast("–ü–æ–±–µ–≥ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è. –¢–µ–±—è —Å–∫—Ä—É—Ç–∏–ª–∏ –Ω–∞ –≤–æ–∫–∑–∞–ª–µ, –Ω–æ –æ—Ç–ø—É—Å—Ç–∏–ª–∏. –ü–æ—Ç–µ—Ä—è–ª –ø–æ–ª–æ–≤–∏–Ω—É –±–∞–±–æ–∫ –∏ –Ω–µ—Ä–≤–æ–≤! **–ü–û–ô–ú–ê–ù** üö®", 'danger');
                audioSystem.play('threat');
                addEvent("–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–±–µ–≥–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞. –ü–æ—Ç–µ—Ä—è–ª —á–∞—Å—Ç—å –¥–µ–Ω–µ–≥ –∏ –Ω–µ—Ä–≤–æ–≤. **–ó–ê–°–í–ï–¢–ò–õ–°–Ø**", "danger", 'fa-user-secret');
                nextDay();
                return;
            }

            // –£—Å–ø–µ—à–Ω—ã–π –ø–æ–±–µ–≥
            changeStat('money', -ESCAPE_COST);
            gameState.debt = 0; 
            endGame("üó∫Ô∏è –°–í–ê–õ–ò–õ –ò–ó –ö–£–†–°–ö–ê", phrases.gameOver.escape);
        }

        function showUpgradeModal() {
            const container = document.getElementById('upgrade-options'); container.innerHTML = '';
            UPGRADES.forEach(item => {
                const level = gameState.skills[item.id];
                const isMax = level >= item.limit;
                
                const el = document.createElement('div'); el.className = 'option';
                
                let button;
                if (isMax) {
                    button = `<button disabled>–ú–ê–ö–° –õ–ï–í–ï–õ</button>`;
                } else {
                    button = `<button ${gameState.money < item.cost ? 'disabled' : ''} onclick="buyUpgrade('${item.id}', ${item.cost})">–ö—É–ø–∏—Ç—å (${item.cost.toLocaleString()} ‚ÇΩ)</button>`;
                }
                
                const currentBonus = item.id === 'stress' ? `-${gameState.skills.stress * item.bonus * 100}%` : (item.id === 'health' ? `+${gameState.skills.health * item.bonus}` : `+${gameState.skills.friends * item.bonus * 100}%`);
                const nextBonusText = isMax ? ' - ' : ` (–°–ª–µ–¥—É—é—â–∏–π: ${item.id === 'stress' ? `-${(level + 1) * item.bonus * 100}%` : (item.id === 'health' ? `+${(level + 1) * item.bonus}` : `+${(level + 1) * item.bonus * 100}%`)})`;

                el.innerHTML = `<strong><i class="fa-solid ${item.icon}"></i> ${item.name} (–£—Ä–æ–≤–µ–Ω—å ${level}/${item.limit})</strong><br><small>${item.desc} | –¢–µ–∫—É—â–∏–π –±–æ–Ω—É—Å: **${currentBonus}** ${nextBonusText}</small>${button}`;
                container.appendChild(el);
            });
            showModal('upgrade-modal');
        }

        function buyUpgrade(id, cost) {
            const upgrade = UPGRADES.find(u => u.id === id);
            
            if (gameState.money < cost) {
                showToast("–£ —Ç–µ–±—è –Ω–µ—Ç —Å—Ç–æ–ª—å–∫–æ –±–∞–±–æ–∫, –µ–±–∞–Ω–∞—à–∫–∞!", 'danger');
                audioSystem.play('fail');
                return;
            }
            if (gameState.skills[id] >= upgrade.limit) {
                showToast("–¢—ã —É–∂–µ –ø—Ä–æ–∫–∞—á–∞–ª—Å—è –ø–æ –º–∞–∫—Å–∏–º—É–º—É, –º—É–¥–∏–ª–∞!", 'warning');
                return;
            }

            changeStat('money', -cost);
            gameState.skills[id]++;
            
            showToast(`–ü—Ä–æ–∫–∞—á–∫–∞ ${upgrade.name} –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +1 –£—Ä–æ–≤–µ–Ω—å! üí™ **–ü–†–û–§–ò–¢**`, 'success');
            addEvent(`–ü—Ä–æ–∫–∞—á–∞–ª ${upgrade.name}. –¢–µ–ø–µ—Ä—å —Ç—ã —á—É—Ç—å –º–µ–Ω–µ–µ –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω. **APPLY SKILL**`, 'success', upgrade.icon);

            if (id === 'health') {
                changeStat('health', upgrade.bonus);
            }

            hideModal('upgrade-modal');
            updateUI();
            saveGame();
        }

        // --- –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª–æ–∫ –∏ —Å–æ–±—ã—Ç–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        function showModal(id) { document.getElementById(id).classList.add('show'); haptic('light');}
        function hideModal(id) { 
            const modal = document.getElementById(id);
            modal.classList.remove('show');
        }

        function showFriendsModal() {
            const container = document.getElementById('friends-options'); container.innerHTML = '';
            const upgradeData = UPGRADES.find(u => u.id === 'friends');
            const friendChanceBonus = gameState.skills.friends * upgradeData.bonus;

            gameState.friends.forEach(friend => {
                const loanAmount = friend.maxLoan;
                const repaymentAmount = friend.repayment || loanAmount;
                const finalChance = Math.min(friend.chance + friendChanceBonus, 0.99);

                const el = document.createElement('div'); el.className = 'option';
                let button;
                
                if (friend.debtAmount > 0) {
                    const status = `(–î–æ–ª–≥: ${friend.debtAmount.toLocaleString()} ‚ÇΩ)`;
                    const isDisabled = gameState.money < friend.debtAmount;
                    button = `<button class="repay" ${isDisabled ? 'disabled' : ''} onclick="repayFriend('${friend.name}')">–í–µ—Ä–Ω—É—Ç—å</button>`;
                    el.innerHTML = `<strong>${friend.name}</strong> ${status}<br><small>${friend.desc}</small><small style="color:${isDisabled ? 'var(--danger)' : 'var(--success)'}">–ù—É–∂–Ω–æ: ${friend.debtAmount.toLocaleString()} ‚ÇΩ</small>${button}`;
                } else {
                    const extraInfo = friend.repayment ? ` (–í–µ—Ä–Ω—É—Ç—å ${repaymentAmount.toLocaleString()} ‚ÇΩ)` : '';
                    const chanceDisplay = `–®–∞–Ω—Å: ${Math.round(finalChance * 100)}%`;
                    button = `<button onclick="borrowFromFriend('${friend.name}')">–ó–∞–Ω—è—Ç—å</button>`;
                    el.innerHTML = `<strong>${friend.name}</strong> (${loanAmount.toLocaleString()} ‚ÇΩ)${extraInfo}<br><small>${friend.desc}</small><small style="color:var(--text-low)">${chanceDisplay}</small>${button}`;
                }
                
                container.appendChild(el);
            });
            showModal('friends-modal');
        }
        
        function borrowFromFriend(name) {
            const friend = gameState.friends.find(f => f.name === name);
            const loanAmount = friend.maxLoan;
            
            const upgradeData = UPGRADES.find(u => u.id === 'friends');
            const friendChanceBonus = gameState.skills.friends * upgradeData.bonus;
            const finalChance = friend.chance + friendChanceBonus;

            if (friend.debtAmount > 0) { showToast(`${friend.name}: –°–Ω–∞—á–∞–ª–∞ –≤–µ—Ä–Ω–∏ —Å—Ç–∞—Ä–æ–µ, –ø—ë—Å!`, 'warning'); audioSystem.play('fail'); return; }
            if (gameState.debt > 150000) { showToast(`${friend.name}: –°–ª—ã—à–∞–ª –ø—Ä–æ —Ç–≤–æ–π –¥–æ–ª–≥ –ó–ª–æ–º—É. –ù–∞—Ö—É–π, —è –ø–∞—Å.`, 'danger'); changeStat('stress', 5); audioSystem.play('threat'); return; }

            if (Math.random() <= finalChance) {
                const actualLoan = loanAmount;
                const repaymentAmount = friend.repayment || actualLoan;
                
                changeStat('money', actualLoan); 
                friend.debtAmount = repaymentAmount; 
                showToast(`${friend.name} –æ–¥–æ–ª–∂–∏–ª ${actualLoan.toLocaleString()} ‚ÇΩ. –í–µ—Ä–Ω–∏ ${repaymentAmount.toLocaleString()} ‚ÇΩ, —Å—É–∫–∞! **–£–†–ê**`, 'success');
                addEvent(`–ó–∞–Ω—è–ª —É ${friend.name}: ${actualLoan.toLocaleString()} ‚ÇΩ. –í–µ—Ä–Ω—É—Ç—å: ${repaymentAmount.toLocaleString()} ‚ÇΩ.`, 'success', 'fa-handshake-angle');
                audioSystem.play('money');
            } else {
                changeStat('stress', 15);
                showToast(`${friend.name} ${phrases.friendReject[Math.floor(Math.random() * phrases.friendReject.length)]} üñï **–õ–û–•**`, 'danger');
                audioSystem.play('fail');
                setStepaAnimation('danger-shake', 1);
            }
            hideModal('friends-modal'); updateUI(); saveGame();
        }

        function repayFriend(name) {
             const friend = gameState.friends.find(f => f.name === name);
             if (gameState.money < friend.debtAmount) { showToast(`–ù–µ—Ç –±–∞–±–æ–∫, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –¥–æ–ª–≥ ${friend.debtAmount.toLocaleString()} ‚ÇΩ, –ø–∏–∑–¥–µ—Ü! üò≠`, "danger"); audioSystem.play('fail'); return; }
             
             changeStat('money', -friend.debtAmount);
             showToast(`–¢—ã –≤–µ—Ä–Ω—É–ª –¥–æ–ª–≥ ${friend.name}. –û–Ω —Å–Ω–æ–≤–∞ —Å—á–∏—Ç–∞–µ—Ç —Ç–µ–±—è —á–µ–ª–æ–≤–µ–∫–æ–º. –ö—Ä–∞—Å–∞–≤–∞. **–ü–ê–¶–ê–ù** ü§ù`, 'success');
             addEvent(`–í–µ—Ä–Ω—É–ª –¥–æ–ª–≥ ${friend.debtAmount.toLocaleString()} ‚ÇΩ. ${friend.name} –¥–æ–≤–æ–ª–µ–Ω.`, 'success', 'fa-money-bill-transfer');
             friend.debtAmount = 0;
             audioSystem.play('success');
             hideModal('friends-modal'); updateUI(); saveGame();
        }

        function showFoodModal() {
            const container = document.getElementById('food-options'); container.innerHTML = '';
            food.forEach(item => {
                const el = document.createElement('div'); el.className = 'option';
                const healthText = item.health === 0 ? '0' : (item.health > 0 ? `+${item.health}` : `${item.health}`);
                const stressText = item.stress === 0 ? '0' : (item.stress > 0 ? `+${item.stress}` : `${item.stress}`);
                const isDisabled = gameState.money < item.cost;
                
                el.innerHTML = `<strong><i class="fa-solid ${item.icon}"></i> ${item.name}</strong> - ${item.cost.toLocaleString()} ‚ÇΩ<br><small>–°—ã—Ç–æ—Å—Ç—å: +${item.satiety}, –ó–¥–æ—Ä–æ–≤—å–µ: ${healthText}, –°—Ç—Ä–µ—Å—Å: ${stressText}</small><button ${isDisabled ? 'disabled' : ''} onclick="eat('${item.name}')">–°–∫—É—à–∞—Ç—å</button>`;
                container.appendChild(el);
            });
            showModal('food-modal');
        }

        function eat(name) {
            const foodItem = food.find(f => f.name === name);
            if (gameState.money < foodItem.cost) { showToast("–î–µ–Ω–µ–≥ –Ω–µ—Ç –¥–∞–∂–µ –Ω–∞ –µ–¥—É, –∏–¥–∏ —Ä–∞–±–æ—Ç–∞–π, —Ö—É–µ—Å–æ—Å!", "danger"); audioSystem.play('fail'); return; }
            
            changeStat('money', -foodItem.cost); 
            changeStat('satiety', foodItem.satiety); 
            changeStat('health', foodItem.health); 
            changeStat('stress', foodItem.stress);
            
            addEvent(`–ü–æ–µ–ª: ${foodItem.name}. –ó–∞—Ç–∫–Ω—É–ª —Å–≤–æ–µ –µ–±–∞–ª–æ. –•–æ—Ç—å –∫–∞–∫–∞—è-—Ç–æ —Ä–∞–¥–æ—Å—Ç—å. **–ú–ù–Ø–ú**`, 'success', foodItem.icon);
            audioSystem.play('success');
            hideModal('food-modal'); 
            nextDay(); 
        }

        function showShadyDealsModal() {
            const container = document.getElementById('shady-deals-options'); container.innerHTML = '';
            shadyDeals.forEach(deal => {
                const el = document.createElement('div');
                el.className = 'option';
                const cost = deal.cost > 0 ? deal.cost : 0;
                const costDisplay = deal.cost < 0 ? `–ù–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª: ${Math.abs(deal.cost).toLocaleString()} ‚ÇΩ (–¢—ã –ø–æ–ª—É—á–∞–µ—à—å)` : `–°—Ç–∞–≤–∫–∞: ${deal.cost.toLocaleString()} ‚ÇΩ`;
                const penaltyDisplay = deal.penalty === 0 ? '–ù–µ—Ç' : Math.abs(deal.penalty).toLocaleString() + ' ‚ÇΩ';
                const healthDisplay = deal.health ? `, –ó–¥–æ—Ä–æ–≤—å–µ: ${deal.health}` : '';
                const isDisabled = gameState.money < cost;

                el.innerHTML = `<strong><i class="fa-solid ${deal.icon}"></i> ${deal.name}</strong><br><small>${deal.desc}</small><br><small style="color:var(--text-low)">${costDisplay} | –ü—Ä–æ—Ñ–∏—Ç (–£—Å–ø–µ—Ö): ${deal.reward.toLocaleString()} ‚ÇΩ | –ü–æ—Ç–µ—Ä–∏ (–ü—Ä–æ–≤–∞–ª): ${penaltyDisplay}${healthDisplay} | –®–∞–Ω—Å: ${deal.chance*100}%</small><button ${isDisabled ? 'disabled' : ''} onclick="attemptShadyDeal('${deal.name}')">–†–∏—Å–∫–Ω—É—Ç—å</button>`;
                container.appendChild(el);
            });
            showModal('shady-deals-modal');
        }

        function attemptShadyDeal(name) {
            const deal = shadyDeals.find(d => d.name === name);
            const cost = deal.cost > 0 ? deal.cost : 0;
            
            if (gameState.money < cost) {
                showToast("–£ —Ç–µ–±—è –Ω–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ —Ç–∞–∫—É—é –∞–≤–∞–Ω—Ç—é—Ä—É, –Ω–∏—â–µ–±—Ä–æ–¥!", 'danger');
                audioSystem.play('fail');
                return;
            }
            if (deal.cost > 0) changeStat('money', -cost);
            else changeStat('money', Math.abs(deal.cost)); 

            changeStat('stress', deal.stress);
            if (deal.health) changeStat('health', deal.health);
            let icon = deal.icon;

            if (Math.random() <= deal.chance) {
                const profit = deal.reward;
                changeStat('money', profit);
                showToast(`–ê—Ñ–µ—Ä–∞ —É–¥–∞–ª–∞—Å—å, –∫—Ä–∞—Å–∞–≤–∞! –¢—ã –ø–æ–¥–Ω—è–ª ${profit.toLocaleString()} ‚ÇΩ! ü§ò **WINNER**`, 'success');
                addEvent(`–¢—ã –ø—Ä–æ–≤–µ—Ä–Ω—É–ª ${deal.name} –∏ —Å–æ—Ä–≤–∞–ª –∫—É—à. ${gameState.creditor} –≤ –∞—Ö—É–µ. **–ò–ó–ò**`, 'success', 'fa-hand-holding-dollar');
                audioSystem.play('money');
                setStepaAnimation('doge-vibe', 1.5);
            } else {
                changeStat('money', deal.penalty);
                showToast(`–¢–µ–±—è –∫–∏–Ω—É–ª–∏, –ª–æ—Ö –µ–±–∞–Ω—ã–π! –ü–æ—Ç–µ—Ä—è–Ω–æ ${Math.abs(deal.penalty).toLocaleString()} ‚ÇΩ ü§° **–û–ô**`, 'danger');
                addEvent(`–°—Ö–µ–º–∞ ${deal.name} –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å. –¢—ã –≤ –µ—â–µ –±–æ–ª—å—à–µ–π –∂–æ–ø–µ, –º—É–¥–∞–∫. **–ù–ï –§–ê–†–¢–ò–¢**`, 'danger', 'fa-skull-crossbones');
                audioSystem.play('fail');
                setStepaAnimation('danger-shake', 1.5);
            }
            hideModal('shady-deals-modal');
            nextDay(); 
        }
        
        // --- –°–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã ---
        function randomEvent() {
            const events = [
                () => { changeStat('money', 1500); addEvent("–ù–∞—à—ë–ª 1500 ‚ÇΩ —É –ª–∞—Ä—å–∫–∞! –°–µ–≥–æ–¥–Ω—è —Ñ–∞—Ä—Ç–∏—Ç. **–ü–û–î–ê–†–û–ö** üëç", 'success', 'fa-sack-dollar'); audioSystem.play('money'); },
                () => { if(gameState.money > 2000) { changeStat('money', -2000); showToast("–¶—ã–≥–∞–Ω–µ —Ä–∞–∑–≤–µ–ª–∏ –Ω–∞ 2000 ‚ÇΩ. –õ–æ—Ö - —ç—Ç–æ —Å—É–¥—å–±–∞, —Ö—É–ª–∏. ü§¶‚Äç‚ôÇÔ∏è **–ö–ò–î–û–ö**", 'danger'); audioSystem.play('fail'); addEvent("–¶—ã–≥–∞–Ω–µ —Ä–∞–∑–≤–µ–ª–∏ –Ω–∞ 2–∫. –ü–∏–∑–¥–µ—Ü.", 'danger', 'fa-comments-dollar'); }},
                () => { changeStat('health', -15); showToast("–ü—Ä–æ—Å—Ç—É–¥–∏–ª—Å—è –ø–æ–¥ –¥–æ–∂–¥–µ–º, –∑–¥–æ—Ä–æ–≤—å–µ —É—Ö—É–¥—à–∏–ª–æ—Å—å. –ï–±–∞—Ç—å, —Ç—ã —Å–ª–∞–±–∞–∫. ü§ß **–°–õ–ê–ë–ê–ö**", 'warning'); addEvent("–ó–∞–±–æ–ª–µ–ª–∞ —Å–ø–∏–Ω–∞ –∏ –∂–æ–ø–∞. –ö–∞–∂–µ—Ç—Å—è, —ç—Ç–æ –ø—Ä–æ—Å—Ç—É–¥–∞.", 'warning', 'fa-temperature-low');},
                () => { changeStat('stress', -25); showToast("–ü–æ —Ç–µ–ª–µ–∫—É –ø–æ–∫–∞–∑–∞–ª–∏ –ë—Ä–∏–≥–∞–¥—É. –ù–∞ –¥—É—à–µ —Å—Ç–∞–ª–æ —Ç–µ–ø–ª–æ. –≠—Ö, –≤—Ä–µ–º–µ–Ω–∞... üòå **–ù–û–°–¢–ê–õ–¨–ì–ò–Ø**", 'success'); addEvent("–ü–æ—Å–º–æ—Ç—Ä–µ–ª –ª—é–±–∏–º—ã–π —Å–µ—Ä–∏–∞–ª, –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–ø—É—Å—Ç–∏–ª–æ.", 'success', 'fa-tv'); },
                () => { changeStat('health', 5); changeStat('satiety', -5); addEvent("–ù–∞—à–µ–ª –≤ –º—É—Å–æ—Ä–∫–µ –ø–æ—á—Ç–∏ —Ü–µ–ª—É—é –±—É–ª–∫—É. –°–ª–µ–≥–∫–∞ –ø–æ–¥–∑–∞—Ä—è–¥–∏–ª—Å—è. **–ü–ï–†–ï–ö–£–°**", 'success', 'fa-utensils'); audioSystem.play('success'); },
                () => { changeStat('stress', 15); showToast(`–í—Å–ø–æ–º–Ω–∏–ª, –∫–∞–∫ ${gameState.creditor} —Å–º–æ—Ç—Ä–µ–ª –Ω–∞ —Ç–µ–±—è. –£—Ö, –∞–∂ –ø—Ä–æ–ø–æ—Ç–µ–ª. ü•µ **–¢–†–ï–í–û–ì–ê**`, 'danger'); setStepaAnimation('danger-shake', 1.5); addEvent("–¢—Ä–µ–≤–æ–≥–∞, —Å—É–∫–∞. –Ø –¥–æ–ª–∂–µ–Ω –±–∞–±–∫–∏.", 'danger', 'fa-face-anxious-sweat'); } 
            ];
            events[Math.floor(Math.random() * events.length)]();
        }
        
        function creditorHarassment() {
            const threat = phrases.debtThreats[Math.floor(Math.random() * phrases.debtThreats.length)];
            showToast(threat.replace("–ö–æ–ª–ª–µ–∫—Ç–æ—Ä –ó–ª–æ–π", gameState.creditor), 'danger');
            changeStat('stress', 30);
            setStepaAnimation('danger-shake', 1.5);
            audioSystem.play('threat');
            addEvent(`–ö—Ä–µ–¥–∏—Ç–æ—Ä—Å–∫–∏–π –∑–≤–æ–Ω–æ–∫: ${gameState.creditor} —à–ª–µ—Ç —É–≥—Ä–æ–∑—ã. –ù–∞–¥–æ –ø–ª–∞—Ç–∏—Ç—å.`, 'danger', 'fa-phone-volume');
        }

        function checkGameOver() {
            if (gameState.gameOver) return;
            
            if (gameState.health <= 0) endGame("üíÄ –°–î–û–• –û–¢ –ñ–ò–ó–ù–ò", phrases.gameOver.health);
            else if (gameState.stress >= 100) endGame("ü§Ø –ü–û–ï–•–ê–õ –ö–£–ö–£–•–û–ô", phrases.gameOver.stress);
            else if (gameState.day > gameState.maxDays && gameState.debt > 0) endGame(`üî´ –†–ê–°–ü–†–ê–í–ê –û–¢ ${gameState.creditor.toUpperCase()}`, phrases.gameOver.debt); 
            else if (gameState.debt <= 0) endGame("üéâ –ü–û–ë–ï–î–ê, –ë–õ–Ø–¢–¨!", phrases.gameOver.win);
        }

        function endGame(title, text) {
            gameState.gameOver = true; saveGame(); haptic('error');
            document.getElementById('game-over-title').textContent = title;
            document.getElementById('game-over-text').textContent = text.replace("–ö–æ–ª–ª–µ–∫—Ç–æ—Ä—É –ó–ª–æ–º—É", gameState.creditor);
            showModal('game-over-modal');
            if(title.includes('–ü–û–ë–ï–î–ê') || title.includes('–°–í–ê–õ–ò–õ')) audioSystem.play('win');
            else audioSystem.play('gameover');
            ui.actionButtons.forEach(btn => btn.disabled = true);
        }
        
        function restartGame() {
            localStorage.removeItem('stepaGameState');
            initGame(true); 
            hideModal('game-over-modal');
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ ---
        function saveGame() {
            localStorage.setItem('stepaGameState', JSON.stringify(gameState));
        }

        function loadGame() {
            const savedState = localStorage.getItem('stepaGameState');
            if (savedState) {
                const loadedState = JSON.parse(savedState);
                if (loadedState.day && loadedState.money !== undefined) {
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –∏ –≥–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞–ª–∏—á–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
                    const baseState = JSON.parse(JSON.stringify(initialGameState));
                    Object.keys(baseState).forEach(key => {
                        if (loadedState[key] === undefined) loadedState[key] = baseState[key];
                    });
                    
                    if (!loadedState.friends || loadedState.friends.length !== baseState.friends.length) {
                       loadedState.friends = JSON.parse(JSON.stringify(baseState.friends));
                    } else {
                        loadedState.friends.forEach((f, i) => {
                            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏–∑ initialGameState –µ—Å—Ç—å
                            f.maxLoan = baseState.friends[i].maxLoan;
                            f.repayment = baseState.friends[i].repayment;
                            f.desc = baseState.friends[i].desc;
                        });
                    }
                    
                    const maxHealth = 100 + (loadedState.skills.health || 0) * 10;
                    if (loadedState.health > maxHealth) loadedState.health = maxHealth;
                    
                    gameState = loadedState;
                } else {
                    gameState = JSON.parse(JSON.stringify(initialGameState));
                }
            } else {
                gameState = JSON.parse(JSON.stringify(initialGameState));
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        function initGame(forceWelcome = false) {
            loadGame();
            
            document.getElementById('welcome-days').textContent = gameState.maxDays;
            document.getElementById('welcome-escape').textContent = ESCAPE_COST.toLocaleString('ru-RU');

            if (gameState.day === 1 || forceWelcome) {
              addEvent(`–ü—Ä–æ—Å–Ω—É–ª—Å—è —Å –±–æ–¥—É–Ω–∞. –ö–∞–∂–µ—Ç—Å—è, —è –¥–æ–ª–∂–µ–Ω ${gameState.creditor}... –ü–∏–∑–¥–µ—Ü. **–ù–ï –í–ï–ó–ï–¢**`, "warning", 'fa-face-sad-cry');
              ui.welcomeModal.classList.add('show');
            }

            document.querySelector('.action-btn.escape').innerHTML = `<i class="fa-solid fa-plane-departure"></i>–°–≤–∞–ª–∏—Ç—å –Ω–∞—Ö—É–π (${ESCAPE_COST.toLocaleString('ru-RU')} ‚ÇΩ)`;

            updateUI();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.action-btn, .modal-close, .option button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    haptic('light');
                });
            });
            initGame();
        });
    </script>
</body>
</html>

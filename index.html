<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Степа: Жизнь Должника</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..900&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- ЦВЕТА И ПЕРЕМЕННЫЕ (Neon Glass UI) --- */
        :root {
            --bg-dark-soft: #121218; /* Ещё более тёмный фон */
            --bg-light-soft: #f0f0f4; /* Мягкий светлый фон */
            --primary: #00eaff; /* Неоновый голубой (Акцент) */
            --secondary: #ff0077; /* Неоновый розовый (Опасность/Действие) */
            --text-main: #2c2c34;
            --text-low: #6a6a70;
            --glass-light: rgba(255, 255, 255, 0.5); /* Более прозрачное стекло */
            --glass-dark: rgba(255, 255, 255, 0.1);
            --success: #4eff00;
            --danger: #ff004c;
            --warning: #ffaa00;
        }
        
        /* --- БАЗОВЫЕ СТИЛИ И АДАПТИВНОСТЬ (Уменьшение интерфейса) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        body {
            background: linear-gradient(160deg, var(--bg-light-soft) 0%, #d8d8e0 100%);
            color: var(--text-main);
            min-height: 100dvh;
            padding: 8px; /* Немного уменьшили отступы */
            overflow-x: hidden;
            touch-action: manipulation;
            font-size: clamp(12px, 3.5vw, 15px); /* Уменьшили базовый шрифт */
        }
        
        .container { max-width: 450px; margin: 0 auto; } /* Уменьшили максимальную ширину */
        
        /* --- GLASS CARD (Матовое стекло) --- */
        .card {
            background: var(--glass-light);
            padding: 15px; /* Уменьшили padding */
            border-radius: 20px; /* Сделали более изящными */
            margin-bottom: 12px;
            backdrop-filter: blur(12px) saturate(180%); /* Усилили эффект */
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* --- ЗАГОЛОВОК --- */
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(1.4rem, 6vw, 1.8rem); /* Уменьшили размер */
            text-align: center;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(0, 234, 255, 0.7), 0 0 5px rgba(0, 234, 255, 0.5); /* Неоновый эффект */
            margin-bottom: 12px;
            font-weight: 800;
            letter-spacing: 1px;
            animation: neonPulse 2s infinite alternate; /* Анимация заголовка */
        }

        @keyframes neonPulse {
            from { text-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary); }
            to { text-shadow: 0 0 10px var(--primary), 0 0 15px var(--primary), 0 0 20px rgba(0, 234, 255, 0.5); }
        }
        
        /* --- СТАТИСТИКА В ШАПКЕ --- */
        .stats { gap: 10px; } /* Уменьшили gap */
        
        .stat-item {
            padding: 10px 8px; /* Уменьшили padding */
            border-radius: 15px;
            font-size: 0.7rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: clamp(1.1rem, 5vw, 1.4rem); /* Уменьшили размер */
        }

        /* --- ПРОГРЕСС БАРЫ (Интерактивные, цветные слайдеры) --- */
        .progress-card { padding: 12px 18px; }
        .progress-container { gap: 3px; }
        .progress-label { 
            font-size: 0.85rem; 
            font-weight: 700;
            color: var(--text-main);
            text-shadow: 0 0 1px rgba(0,0,0,0.1);
        }

        .progress-bar { 
            height: 16px; /* Чуть выше */
            background: rgba(0, 0, 0, 0.15); /* Темнее для контраста */
            border-radius: 8px; 
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .progress-fill { 
            height: 100%; 
            transition: width 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Более медленная и плавная анимация */
            border-radius: 8px;
            position: absolute;
            left: 0; top: 0;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3); /* Добавляем тень к заполнению */
        }
        /* Цвета с градиентами */
        #stress-bar .progress-fill { background: linear-gradient(90deg, #ffc107, var(--secondary)); box-shadow: 0 0 10px var(--secondary); }
        #health-bar .progress-fill { background: linear-gradient(90deg, #7cfc00, var(--success)); box-shadow: 0 0 10px var(--success); }
        #satiety-bar .progress-fill { background: linear-gradient(90deg, var(--primary), #ffab00); box-shadow: 0 0 10px var(--primary); }
        
        /* Индикация низкого здоровья/высокого стресса */
        .progress-card.warning-flash { animation: flashWarning 0.5s infinite alternate; }
        @keyframes flashWarning { from { box-shadow: 0 0 10px var(--danger); } to { box-shadow: 0 0 5px transparent; } }

        /* --- ПЕРСОНАЖ: СТЕПА --- */
        .character-container {
            margin: 15px 0;
            font-size: clamp(5rem, 20vw, 7rem); /* Уменьшили размер */
            perspective: 1000px;
            line-height: 1; /* Убрали лишние отступы */
        }
        .stepa-emoji-wrapper { 
            display: inline-block; 
            transform-style: preserve-3d;
        }

        /* --- КНОПКИ ДЕЙСТВИЙ (Neon Glass Buttons) --- */
        .actions { gap: 8px; } /* Уменьшили gap */
        
        .action-btn {
            padding: 8px 5px; /* Уменьшили padding */
            border-radius: 18px;
            font-size: 0.7rem; /* Уменьшили шрифт */
            min-height: 85px; /* Уменьшили высоту */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
        }
        .action-btn i { 
            font-size: clamp(1.4rem, 4vw, 1.8rem); 
            color: var(--primary); 
            text-shadow: 0 0 5px rgba(0, 234, 255, 0.5); /* Неоновая тень */
        }
        .action-btn:not(:disabled):hover { 
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15), inset 0 0 0 1px rgba(255, 255, 255, 0.8);
        }
        
        /* Специальные кнопки с градиентом */
        .action-btn.pay, .action-btn.escape {
            font-size: 0.9rem;
            min-height: 45px;
        }
        .action-btn.pay { background: linear-gradient(45deg, #00b300 0%, var(--success) 100%); box-shadow: 0 4px 15px rgba(78, 255, 0, 0.5); }
        .action-btn.escape { background: linear-gradient(45deg, #cc00ff 0%, var(--secondary) 100%); box-shadow: 0 4px 15px rgba(255, 0, 119, 0.5); }
        .action-btn.pay i, .action-btn.escape i { color: white; text-shadow: 0 0 5px rgba(255, 255, 255, 0.5); }

        /* --- ЛОГ СОБЫТИЙ --- */
        .events {
            max-height: 200px; /* Уменьшили высоту */
            padding-right: 8px;
            background: rgba(0, 0, 0, 0.03); 
        }

        .event { 
            padding: 8px; 
            margin-bottom: 6px; 
            border-radius: 15px; 
        }
        
        /* --- АНИМАЦИИ (Обновление) --- */
        @keyframes idle-bob { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-8px) rotate(-1deg); } }
        @keyframes danger-shake { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0) rotate(-3deg); } 20%, 40%, 60%, 80% { transform: translate(5px, 0) rotate(3deg); } }
        @keyframes doge-vibe { 0%, 100% { transform: rotateY(0deg) scale(1); } 50% { transform: rotateY(20deg) scale(1.05); } }
        @keyframes pulse-success { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); color: var(--success); text-shadow: 0 0 15px var(--success); } }
        @keyframes pulse-danger { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); color: var(--danger); text-shadow: 0 0 15px var(--danger); } }
        
        .steep-anim { animation: doge-vibe 1.5s ease-in-out; }
        .success-anim { animation: pulse-success 0.5s ease-out; }
        .danger-anim { animation: pulse-danger 0.5s ease-out; }

    </style>
</head>
<body>
    <div id="toast-container" style="position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px; width: 95%; max-width: 400px;"></div>
    
    <audio id="sound-money" src="https://assets.mixkit.co/sfx/download/mixkit-game-quick-positive-notification-202.wav" preload="auto"></audio> 
    <audio id="sound-fail" src="https://assets.mixkit.co/sfx/download/mixkit-app-error-2183.wav" preload="auto"></audio> 
    <audio id="sound-threat" src="https://assets.mixkit.co/sfx/download/mixkit-thunder-strike-456.wav" preload="auto"></audio> 
    <audio id="sound-success" src="https://assets.mixkit.co/sfx/download/mixkit-game-magic-sweep-2412.wav" preload="auto"></audio> 
    <audio id="sound-gameover" src="https://assets.mixkit.co/sfx/download/mixkit-retro-arcade-game-over-470.wav" preload="auto"></audio> 
    <audio id="sound-win" src="https://assets.mixkit.co/sfx/download/mixkit-game-success-alert-2005.wav" preload="auto"></audio> 

    <div id="welcome-modal" class="modal show">
        <div class="modal-content welcome-screen card">
            <h3 style="color:var(--secondary); text-align: center; font-size: 1.6rem; font-family: 'Orbitron';">🚨 СТЕПА: ДОЛГОВАЯ ЯМА 🚨</h3>
            <hr style="margin: 15px 0; border: none; height: 1px; background: rgba(0,0,0,0.1);"/>
            <p style="font-style: italic; color: var(--text-low); margin-bottom: 20px; text-align: center;">Ты взял 100к на очень мутные дела. Долг выкупил **Кредитор Злой**, и теперь он знает, где ты живешь, **уебок**.</p>
            <p style="font-weight: bold; color: var(--primary); text-align: center;">Твоя цель, сука:</p>
            <ul style="margin-left: 25px; list-style-type: '👉 '; color: var(--text-main);">
                <li>Вернуть долг: **100 000 ₽** Злому. Срок: <span id="welcome-days">30</span> дней.</li>
                <li>Или **свалить нахуй** в Ростов за <span id="welcome-escape">65 000</span> ₽, пока тебе не сломали **ебало**.</li>
            </ul>
            <p style="margin-top: 20px; font-weight: bold; color: var(--danger); text-align: center;">ПРАВИЛА (Следи за шкалами, **тупица**):</p>
            <ul style="color: var(--text-dark); margin-left: 25px; list-style-type: '🔥 ';">
                <li>**Здоровье 0:** Пиздец, ты сдох. Конец.</li>
                <li>**Стресс 100:** Кукуха в ауте. Ты теперь овощ.</li>
                <li>**Сытость 0:** Голодный обморок, минус здоровье.</li>
            </ul>
            <button class="modal-close" style="background: var(--primary);" onclick="hideModal('welcome-modal')">НАЧАТЬ ЭТУ ЕБАНУЮ ЖИЗНЬ</button>
        </div>
    </div>

    <div class="container">
        <div class="header card">
            <h1>СТЕПА: ДОЛГОВАЯ ЯМА</h1>
            <div class="stats">
                <div class="stat-item">ДЕНЬ (Из 30)<br><span class="stat-value" id="day">1</span></div>
                <div class="stat-item">БАБКИ<br><span class="stat-value" id="money">5000 ₽</span></div>
                <div class="stat-item">ДОЛГ<br><span class="stat-value" id="debt">100000 ₽</span></div>
                <div class="stat-item">РАБОТА<br><span class="stat-value" id="job">Бомж</span></div>
            </div>
        </div>
        
        <div class="progress-card card" id="progress-card">
            <div class="progress-container">
                <div class="progress-label">Здоровье 💪: <span id="health-value">100</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="health-bar" style="width: 100%;"></div></div>
            </div>
            <div class="progress-container">
                <div class="progress-label">Сытость 🌭: <span id="satiety-value">100</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="satiety-bar" style="width: 100%;"></div></div>
            </div>
            <div class="progress-container" id="stress-progress">
                <div class="progress-label">Стресс 🤯: <span id="stress-value">0</span>%</div>
                <div class="progress-bar"><div class="progress-fill" id="stress-bar" style="width: 0%;"></div></div>
            </div>
        </div>
        
        <div class="character-container"><span class="stepa-emoji-wrapper" id="stepa-emoji" style="animation: idle-bob 4s ease-in-out infinite;">😐</span></div>
        
        <div class="actions">
            <button class="action-btn" onclick="work()"><i class="fa-solid fa-person-digging"></i>Въебывать</button>
            <button class="action-btn" onclick="showFoodModal()"><i class="fa-solid fa-burger"></i>Жрать</button>
            <button class="action-btn" onclick="showFriendsModal()"><i class="fa-solid fa-handshake"></i>Кенты</button>
            <button class="action-btn" onclick="relieveStress()"><i class="fa-solid fa-martini-glass-citrus"></i>Нажраться</button>
            <button class="action-btn" onclick="showShadyDealsModal()"><i class="fa-solid fa-bolt-lightning"></i>Мутки</button>
            <button class="action-btn" onclick="findJob()"><i class="fa-solid fa-briefcase"></i>Искать работу</button>
            <button class="action-btn pay" onclick="payDebt()"><i class="fa-solid fa-money-bill-transfer"></i>ОТДАТЬ ДОЛГ</button>
            <button class="action-btn escape" onclick="attemptEscape()"><i class="fa-solid fa-plane-departure"></i>СВАЛИТЬ НАХУЙ</button>
        </div>
        
        <div class="events card" id="events"></div>
    </div>
    
    <div id="friends-modal" class="modal"><div class="modal-content card"><h3>👥 Кенты (Верни, сука)</h3><div id="friends-options"></div><button class="modal-close" onclick="hideModal('friends-modal')">Закрыть, уебок</button></div></div>
    <div id="food-modal" class="modal"><div class="modal-content card"><h3>🍔 Пожрать (Заткнуть ебало)</h3><div id="food-options"></div><button class="modal-close" onclick="hideModal('food-modal')">Хватит жрать</button></div></div>
    <div id="shady-deals-modal" class="modal"><div class="modal-content card"><h3>😈 Мутные схемы (Наебать судьбу)</h3><div id="shady-deals-options"></div><button class="modal-close" onclick="hideModal('shady-deals-modal')">Сыграл и хватит</button></div></div>
    <div id="game-over-modal" class="modal">
        <div class="modal-content game-over card" style="border: 2px solid var(--danger);">
            <h2 id="game-over-title" style="color:var(--danger); font-size: 2.5rem; margin-bottom: 20px; text-align: center; font-family: 'Orbitron';"></h2>
            <p id="game-over-text" style="font-size: 1.2rem; line-height: 1.5; text-align: center; color: var(--text-main);"></p>
            <button class="modal-close" onclick="restartGame()" style="background: var(--danger);">Начать эту хуйню заново</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg) { 
            tg.expand();
            tg.enableClosingConfirmation();
        }

        // --- АУДИОСИСТЕМА ---
        const audioSystem = {
            money: document.getElementById('sound-money'), fail: document.getElementById('sound-fail'),
            threat: document.getElementById('sound-threat'), success: document.getElementById('sound-success'),
            gameover: document.getElementById('sound-gameover'), win: document.getElementById('sound-win'),
            play: function(sound) {
                const audio = this[sound];
                if (audio && audio.src) {
                    const clone = audio.cloneNode(); clone.volume = 0.4; clone.currentTime = 0;
                    clone.play().catch(e => console.log("Audio playback failed:", e));
                }
            }
        };

        // --- Виброотклик (Haptic Feedback) ---
        function haptic(type) {
            if (!tg || !tg.HapticFeedback) return;
            try {
                const styles = { error: 'error', success: 'success', warning: 'warning', light: 'light', medium: 'medium', heavy: 'heavy' };
                const hapticType = styles[type] || 'light';
                if(['error', 'success', 'warning'].includes(hapticType)) tg.HapticFeedback.notificationOccurred(hapticType);
                else tg.HapticFeedback.impactOccurred(hapticType);
            } catch (e) { console.log("Haptic failed:", e); }
        }
        
        // --- Игровое состояние ---
        const initialGameState = {
            day: 1, maxDays: 30, money: 5000, debt: 100000, health: 100, satiety: 100, stress: 0,
            creditor: "Кредитор Злой", 
            job: { name: "Бомж", salary: 750, stress: 5, health: -5, satiety: -15, isHomeless: true },
            skills: { health: 0, stress: 0, friends: 0 }, // Оставил, чтобы бафы работали, но убрал UI прокачки
            friends: [
                { name: "Васян", desc: "Старый друг, но сам в жопе", maxLoan: 5000, chance: 0.6, debtAmount: 0 },
                { name: "Петруха", desc: "Жадный, считает копейки", maxLoan: 3000, chance: 0.3, debtAmount: 0 },
                { name: "Семёныч", desc: "Душа-парень, под каблуком", maxLoan: 7000, chance: 0.7, debtAmount: 0 },
                { name: "Гриша Кабан", desc: "Браток, даст под лютый процент (Вернуть 150%)", maxLoan: 10000, chance: 0.85, repayment: 15000, debtAmount: 0 },
                { name: "Леха Мутный", desc: "Даст 30к, но с возвратом в 50к", maxLoan: 30000, chance: 0.5, repayment: 50000, debtAmount: 0 }
            ],
            gameOver: false,
        };
        let gameState;

        // --- Константы и данные (Грубые и Смешные Фразы) ---
        const ESCAPE_COST = 65000;
        const food = [
            { name: "Кефир 'Помоги себе сам'", cost: 50, satiety: 10, health: 0, stress: 0, icon: 'fa-bottle-water' },
            { name: "Дошик с кетчунезом", cost: 100, satiety: 25, health: -2, stress: 5, icon: 'fa-bowl-food' },
            { name: "Шаурма 'Пронеси, блядь'", cost: 250, satiety: 40, health: 5, stress: 0, icon: 'fa-sandwich' },
            { name: "Бизнес-ланч 'Как Человек'", cost: 600, satiety: 65, health: 10, stress: -10, icon: 'fa-utensils' },
            { name: "Форель в 'Курском дворике'", cost: 3000, satiety: 100, health: 5, stress: -30, icon: 'fa-fish-fins' } 
        ];
        const jobs = [
            { name: "Грузчик (ебаный)", salary: 1500, stress: 15, health: -10, satiety: -20, isHomeless: false },
            { name: "Курьер-камикадзе", salary: 2000, stress: 10, health: -5, satiety: -25, isHomeless: false },
            { name: "Охранник в Пятерочке", salary: 2500, stress: 5, health: 0, satiety: -10, isHomeless: false },
            { name: "Таксист 'Ветерок' (похуист)", salary: 3500, stress: 20, health: -5, satiety: -15, isHomeless: false },
            { name: "Помощник депутата (Мутка)", salary: 5000, stress: 10, health: 5, satiety: -5, isHomeless: false }
        ];
        const shadyDeals = [
            { name: "Поставить на Рыжего (Дерби)", desc: "Собачьи бои. Верняк. Ставка: 1к. Мем: **ВЖУХ!**", cost: 1000, reward: 5000, chance: 0.4, penalty: -1000, stress: 20, icon: 'fa-dog' },
            { name: "Перевезти диван (Контрабанда)", desc: "В 3 часа ночи. Вопросы лучше не задавать. Мем: **ЭТО РОССИЯ**.", cost: 0, reward: 8000, chance: 0.6, penalty: -5000, stress: 30, icon: 'fa-truck-moving' },
            { name: "Продать витамины у клуба", desc: "Какой-то порошок. Профит: 10к, если мусора не примут. Мем: **ПАНИКА**.", cost: -2000, reward: 10000, chance: 0.3, penalty: -10000, stress: 50, icon: 'fa-capsules' },
            { name: "Взломать игровые автоматы", desc: "Уровень сложности: God Mode. Если прокатит — 20к. Мем: **УДАЧА**.", cost: 5000, reward: 20000, chance: 0.15, penalty: -15000, stress: 40, icon: 'fa-slot-machine' },
            { name: "Сдать Кредитору Злому Лёху", desc: "Предательство за 15к. Удар по здоровью. Мем: **КРЫСА**.", cost: 0, reward: 15000, chance: 0.9, penalty: 0, stress: 50, health: -15, icon: 'fa-user-secret' }
        ];
        // Оставил UPGRADES, чтобы код логики не ломался
        const UPGRADES = [
            { id: 'health', name: 'Навык Выживания (Здоровье)', icon: 'fa-heart-pulse', cost: 10000, bonus: 10, limit: 5, desc: "Увеличивает твою выживаемость. **+10 к базовому Здоровью.**" },
            { id: 'stress', name: 'Навык Дзен (Стресс)', icon: 'fa-brain', cost: 15000, bonus: 0.05, limit: 3, desc: "Уменьшает ежедневный прирост стресса. **-5% ежедневного стресса.**" },
            { id: 'friends', name: 'Навык Убеждения (Кенты)', icon: 'fa-users-line', cost: 20000, bonus: 0.15, limit: 2, desc: "Увеличивает шанс, что кенты дадут в долг. **+15% к шансу.**" },
        ];
        const phrases = {
            work: [
                "Въебывал как раб на галерах. Заработал, сука.", 
                "Горбатился за гроши, проклиная всё на свете. Деньги — говно.", 
                "Продал еще один день жизни за ебучие копейки. Пиздец.", 
                "Имитировал бурную деятельность. Заебался, но бабки получил."
            ],
            workBonus: "Начальник был в запое и случайно выписал премию. Повезло, хули. **DOGE VIBE**",
            workFine: "Опоздал на смену, получил штраф. Ебать, ты лох. **ОБИДНО**",
            workBegging: "Нашел несколько бутылок и сдал их. Мелочь, но приятно, бомжара. **БОМЖ-ЛАЙФ**",
            debtThreats: [
                "📞 Злой: Слышь, **уебан**, бабки где? Я твой дом труба шатал! **BRUH!**", 
                "SMS от Злого: Твои почки стоят 100к. У тебя есть выбор, **сука**. **ДЕЛАЙ ВЫБОР**.", 
                "SMS от Злого: Я знаю где живет твоя Приора. Время пошло. **Пиздец**. **ЗАВТРА ВЫЕЗД**.",
                "📞 Злой: Если ты не заплатишь, я пришлю Лёху. А Лёха — это тебе не Семёныч, **пидор**.",
                "SMS от Злого: Ты не отвечаешь? Готовь очко к приключениям. **ТРЕВОГА**"
            ],
            friendReject: [
                "послал тебя нахуй.", 
                "сказал, что его жена против. **Тряпка**.", 
                "сделал вид, что не узнал тебя, **пидора**.", 
                "сказал, долг платежом красен и съебался в закат."
            ],
            gameOver: {
                health: "Ты сдох от какой-ТО хуйни, потому что не следил за здоровьем, **мудак**. Твои долги перешли коту. Мяу. **RIP Степа** 😿",
                stress: "Твоя кукуха окончательно улетела. Остаток жизни ты проведешь, пуская слюни в дурке и крича **'ГДЕ ДЕНЬГИ, ЛЕБОВСКИ?'**. Ебать, позорище. 🤡",
                debt: "Терпение Кредитора Злого лопнуло. Тебя вывезли в лес и креативно обьяснили, что так делать нельзя. Твои останки до сих пор ищут, **лол**. **FINISH HIM** 🔪",
                win: "Ебать, ты реально смог! Отдал все долги Кредитору Злому. Теперь ты легенда Курска. Можешь съебать отсюда с чистой совестью, **красава**. **ПОТРАЧЕНО** 🎉",
                escape: "Ты свалил из Курска в Ростов! Кредитор Злой в бешенстве. Тебя ищут, но ты на свободе! Новая жизнь начинается с шаурмы на вокзале. **Свобода, блядь!** **FREEDOM** 🕊️"
            },
            relieveStress: [
                "Просадил 1000 ₽ в баре. Стало легче, но печень передает привет. Хули, похуй. **ЗА ЗДОРОВЬЕ**", 
                "Бутылка пива и 'Давай поженимся' - идеальная терапия. -40 стресса. **ЖИЗА**"
            ],
            dailyHunger: "От голода сводит живот. Теряешь здоровье, **хуила**. **НЕ КОРМИЛИ**.",
            workExists: "У тебя уже есть работа, **мудила**! Не рыпайся. 🤨",
            workFail: "Никому ты нахуй не нужен, **неудачник**. Ищи дальше. **НЕ ПОВЕЗЛО** 💩",
            escapeFail: "Побег провалился. Тебя скрутили на вокзале, но отпустили. Потерял половину бабок и нервов! **ПОЙМАН** 🚨"
        };

        // --- Управление UI ---
        const ui = {
            day: document.getElementById('day'), money: document.getElementById('money'), debt: document.getElementById('debt'), job: document.getElementById('job'),
            health: document.getElementById('health-value'), healthBar: document.getElementById('health-bar'),
            satiety: document.getElementById('satiety-value'), satietyBar: document.getElementById('satiety-bar'),
            stress: document.getElementById('stress-value'), stressBar: document.getElementById('stress-bar'),
            stressContainer: document.getElementById('stress-progress').parentNode.parentNode, // progress-card
            healthContainer: document.getElementById('health-bar').parentNode.parentNode.parentNode, // progress-card
            stepaEmoji: document.getElementById('stepa-emoji'), events: document.getElementById('events'), toastContainer: document.getElementById('toast-container'),
            welcomeModal: document.getElementById('welcome-modal'),
            actionButtons: document.querySelectorAll('.action-btn')
        };
        
        let statUpdateTimers = {};
        
        // Временное отключение кнопок для предотвращения спама
        function disableActions(duration = 1000) {
            ui.actionButtons.forEach(btn => btn.disabled = true);
            setTimeout(() => {
                if (!gameState.gameOver) {
                    ui.actionButtons.forEach(btn => btn.disabled = false);
                }
            }, duration);
        }

        // Плавное обновление статистики с анимацией
        function animateStatUpdate(element, newValue, key) {
            const oldValue = element.textContent;
            
            // Пропускаем анимацию для процентов/дней, где нет ₽
            if (!String(newValue).includes('₽') && !String(newValue).includes('/')) {
                element.textContent = newValue;
                return;
            }

            const oldNum = parseFloat(oldValue.replace(/[^\d.-]/g, '')) || 0;
            const newNum = parseFloat(String(newValue).replace(/[^\d.-]/g, '')) || 0;
            
            let changeClass = '';
            
            if (key === 'debt') {
                 if (newNum < oldNum) changeClass = 'success-anim';
                 if (newNum > oldNum) changeClass = 'danger-anim';
            } else if (key === 'money') {
                if (newNum > oldNum) changeClass = 'success-anim';
                if (newNum < oldNum) changeClass = 'danger-anim';
            } else if (key === 'day' || key === 'job') {
                changeClass = 'success-anim';
            }

            element.textContent = newValue;

            if (changeClass) {
                const wrapper = element.parentNode;
                clearTimeout(statUpdateTimers[key]);
                wrapper.classList.remove('success-anim', 'danger-anim');
                void wrapper.offsetWidth; 
                wrapper.classList.add(changeClass);
                statUpdateTimers[key] = setTimeout(() => wrapper.classList.remove(changeClass), 800);
            }
        }
        
        function updateUI() {
            // Анимация денег и долга
            animateStatUpdate(ui.day, `${gameState.day} (Из ${gameState.maxDays})`, 'day');
            animateStatUpdate(ui.money, gameState.money.toLocaleString('ru-RU') + ' ₽', 'money');
            animateStatUpdate(ui.debt, gameState.debt.toLocaleString('ru-RU') + ' ₽', 'debt');
            animateStatUpdate(ui.job, gameState.job.name, 'job');
            
            // Расчет максимального здоровья/стресса с учетом прокачки
            const maxHealth = 100 + gameState.skills.health * 10;
            const maxStress = 100;
            
            const healthPercent = (gameState.health / maxHealth) * 100;
            const stressPercent = (gameState.stress / maxStress) * 100;

            // Обновление шкал
            ui.health.textContent = `${gameState.health} / ${maxHealth}`; ui.healthBar.style.width = `${healthPercent}%`;
            ui.satiety.textContent = gameState.satiety; ui.satietyBar.style.width = `${gameState.satiety}%`;
            ui.stress.textContent = gameState.stress; ui.stressBar.style.width = `${stressPercent}%`;
            
            // Дополнительная анимация на критических значениях
            if (healthPercent < 20 || stressPercent > 80) {
                 ui.stressContainer.classList.add('warning-flash');
            } else {
                 ui.stressContainer.classList.remove('warning-flash');
            }

            updateStepaEmoji();
        }

        function changeStat(stat, value) {
            const maxHealth = 100 + gameState.skills.health * 10;
            
            const oldValue = gameState[stat];
            gameState[stat] = gameState[stat] + value;
            
            if (stat === 'health') gameState[stat] = Math.min(Math.max(0, gameState[stat]), maxHealth);
            else if (stat === 'satiety') gameState[stat] = Math.min(Math.max(0, gameState[stat]), 100);
            else if (stat === 'stress') gameState[stat] = Math.min(Math.max(0, gameState[stat]), 100);
            else if (stat === 'money' || stat === 'debt') gameState[stat] = Math.max(0, gameState[stat]);

            // Проверка на эмоцию/анимацию Степы
            if (stat === 'health' && gameState.health < 30 && oldValue >= 30) {
                setStepaAnimation('danger-shake', 2);
            } else if (stat === 'stress' && gameState.stress > 70 && oldValue <= 70) {
                setStepaAnimation('danger-shake', 2);
            } else if (stat === 'money' && value > 5000) {
                setStepaAnimation('doge-vibe', 1.5);
            }
        }
        
        function setStepaAnimation(animation, duration) {
            const wrapper = ui.stepaEmoji;
            const currentAnim = wrapper.style.animationName;

            // Если уже проигрывается сильная анимация, не прерываем (кроме idle)
            if (currentAnim.includes('shake') || currentAnim.includes('vibe')) return;

            wrapper.style.animation = 'none';
            void wrapper.offsetWidth; 
            wrapper.style.animation = `${animation} ${duration}s ease-in-out`;
            
            // Возвращаем стандартную анимацию
            setTimeout(() => {
                 wrapper.style.animation = 'idle-bob 4s ease-in-out infinite';
                 updateStepaEmoji();
            }, duration * 1000);
        }
        
        function updateStepaEmoji() {
            const wrapper = ui.stepaEmoji;
            const currentAnim = wrapper.style.animationName;
            if (currentAnim !== 'idle-bob' && currentAnim !== 'none' && currentAnim !== '') return; 

            if (gameState.debt <= 0) wrapper.textContent = '🥳'; 
            else if (gameState.stress >= 85) wrapper.textContent = '🤯';
            else if (gameState.health <= 20) wrapper.textContent = '💀';
            else if (gameState.satiety <= 20) wrapper.textContent = '🤢';
            else if (gameState.money > 50000) wrapper.textContent = '🤑';
            else if (gameState.money < 1000) wrapper.textContent = '😭';
            else if (gameState.debt > gameState.money * 10 && gameState.day > 10) wrapper.textContent = '😱';
            else wrapper.textContent = '😐'; 
        }

        function addEvent(message, type = "default", icon = 'fa-circle-info') {
            const eventEl = document.createElement('div');
            eventEl.className = `event ${type}`;
            eventEl.innerHTML = `<i class="fa-solid ${icon} event-icon"></i> <span>День ${gameState.day}: ${message}</span>`;
            ui.events.prepend(eventEl);
            if(ui.events.children.length > 20) ui.events.lastChild.remove();
        }

        function showToast(message, type = "default") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            ui.toastContainer.appendChild(toast);
            
            const hapticMap = { danger: 'error', success: 'success', warning: 'warning', default: 'light' };
            if (hapticMap[type]) haptic(hapticMap[type]);
            
            setTimeout(() => toast.remove(), 5000); 
        }
        
        // --- СМЕНА ДНЯ ---
        function nextDay() {
            if (gameState.gameOver) return;
            
            disableActions();

            changeStat('day', 1);
            
            // Ежедневные дебаффы 
            changeStat('satiety', -10);
            
            let debtStressBase = gameState.debt > 70000 ? 7 : (gameState.debt > 30000 ? 4 : 2);
            // Применяем баф от навыков, если они есть
            const stressUpgrade = UPGRADES.find(u => u.id === 'stress');
            debtStressBase = debtStressBase * (1 - gameState.skills.stress * stressUpgrade.bonus); 
            changeStat('stress', Math.max(1, Math.round(debtStressBase))); 

            if (gameState.satiety <= 0) {
                changeStat('health', -15);
                addEvent(phrases.dailyHunger, "danger", 'fa-drumstick-bite');
                audioSystem.play('fail');
            }
            if(gameState.stress > 0) changeStat('stress', -3); // Небольшое снижение стресса каждый день

            if (Math.random() < 0.3) randomEvent();
            if (gameState.day > 2 && gameState.day % 4 === 0 && gameState.debt > 0) creditorHarassment();

            updateUI();
            checkGameOver();
            saveGame();
        }
        
        // --- Действия игрока ---
        function work() {
            const { salary, stress, health, satiety, isHomeless } = gameState.job;
            let finalSalary = salary;
            let eventMsg = phrases.work[Math.floor(Math.random() * phrases.work.length)];
            let icon = 'fa-money-bill-wave';
            
            const rand = Math.random();

            if (rand < 0.1 && !isHomeless) { 
                finalSalary *= 1.5;
                eventMsg = phrases.workBonus;
                showToast(`Премия, сука! +${(finalSalary - salary).toLocaleString()} ₽`, 'success');
                audioSystem.play('money');
                icon = 'fa-sack-dollar';
            } else if (rand < 0.15) { 
                const fine = isHomeless ? 0 : 500; 
                if (gameState.money >= fine) { 
                     changeStat('money', -fine);
                     finalSalary = salary - fine;
                     showToast(`Штраф! Минус бабки, уебок. -${fine.toLocaleString()} ₽. **ОБИДНО**`, 'danger');
                     eventMsg = phrases.workFine;
                     audioSystem.play('fail');
                     icon = 'fa-hand-holding-dollar';
                } else {
                    eventMsg = "Чудом избежал штрафа, но и зарплата сегодня не светит. **ПРОНЕСЛО**";
                    finalSalary = 0;
                    icon = 'fa-user-slash';
                }
            } else if (isHomeless && rand < 0.3) {
                finalSalary += 200;
                eventMsg = phrases.workBegging;
                audioSystem.play('money');
            }

            changeStat('money', finalSalary);
            changeStat('stress', stress);
            changeStat('health', health);
            changeStat('satiety', satiety);

            haptic('medium');
            setStepaAnimation('doge-vibe', 1);
            addEvent(`${eventMsg} Заработано: ${finalSalary.toLocaleString()} ₽.`, (finalSalary > 0 ? 'success' : 'warning'), icon);
            
            nextDay(); 
        }

        function findJob() {
            if (!gameState.job.isHomeless && Math.random() > 0.6) {
                 showToast(phrases.workExists, 'warning');
                 changeStat('stress', 5);
                 updateUI(); saveGame();
                 return;
            }

            if (Math.random() > 0.4) {
                const newJob = jobs[Math.floor(Math.random() * jobs.length)];
                gameState.job = newJob;
                showToast(`Ты нашел новую работу: ${newJob.name}! Наконец-то, блядь! **СЧАСТЬЕ** 👍`, 'success');
                addEvent(`Наконец-то ты не бомж, а ${newJob.name}. Зарплата ${newJob.salary.toLocaleString()} ₽/день.`, 'success', 'fa-briefcase');
                audioSystem.play('success');
            } else {
                showToast(phrases.workFail, 'danger');
                changeStat('stress', 10);
                audioSystem.play('fail');
            }
            updateUI(); saveGame();
        }
        
        function relieveStress() {
            if (gameState.money < 1000) { showToast("Денег нет даже на бояру, иди нахуй!", "danger"); audioSystem.play('fail'); return; }
            if (gameState.stress < 10) { showToast("Какой-то ты нестрессовый сегодня. Поработай сначала. 🥱", "warning"); return; }
            
            changeStat('money', -1000); changeStat('stress', -40); changeStat('health', -5);
            haptic('medium');
            
            const eventIndex = Math.floor(Math.random() * phrases.relieveStress.length);
            const eventMsg = phrases.relieveStress[eventIndex];
            
            ui.stepaEmoji.textContent = (eventIndex === 0) ? '🥴' : '😌';
            setStepaAnimation('dizzy', 2);
            addEvent(eventMsg, 'success', 'fa-cocktail');
            audioSystem.play('success');
            nextDay(); 
        }
        
        function payDebt() {
            const payment = Math.min(gameState.money, gameState.debt); 
            if (payment <= 0) { showToast(`Нечем платить ${gameState.creditor}, ты нищий кусок говна! 🤡`, "danger"); audioSystem.play('fail'); return; }
            
            changeStat('money', -payment); 
            changeStat('debt', -payment); 
            changeStat('stress', -20);
            
            showToast(`Отдал ${payment.toLocaleString()} ₽. ${gameState.creditor} сегодня не будет ломать тебе ноги. Пока что. **ПАЦАН СКАЗАЛ** 🙏`, "success");
            audioSystem.play('money');
            addEvent(`Отдал часть долга: ${payment.toLocaleString()} ₽. Стало легче дышать. **ОТЛЕГЛО**`, 'success', 'fa-money-bill-transfer');
            updateUI(); checkGameOver(); saveGame();
        }

        function attemptEscape() {
            if (gameState.money < ESCAPE_COST) {
                showToast(`Для побега нужно ${ESCAPE_COST.toLocaleString()} ₽. Иди работай, крыса! 🐀`, "danger");
                audioSystem.play('fail');
                return;
            }

            // Шанс на провал
            if (gameState.debt > 50000 && Math.random() < 0.15) { 
                changeStat('money', -ESCAPE_COST / 2); 
                changeStat('stress', 50);
                showToast(phrases.escapeFail, 'danger');
                audioSystem.play('threat');
                addEvent("Попытка побега провалена. Потерял часть денег и нервов. **ЗАСВЕТИЛСЯ**", "danger", 'fa-user-secret');
                nextDay();
                return;
            }

            // Успешный побег
            changeStat('money', -ESCAPE_COST);
            gameState.debt = 0; 
            endGame("🗺️ СВАЛИЛ ИЗ КУРСКА", phrases.gameOver.escape);
        }
        
        // --- Управление модальными окнами (без изменений) ---
        function showModal(id) { document.getElementById(id).classList.add('show'); haptic('light');}
        function hideModal(id) { 
            const modal = document.getElementById(id);
            modal.classList.remove('show');
        }

        function showFriendsModal() {
            const container = document.getElementById('friends-options'); container.innerHTML = '';
            const upgradeData = UPGRADES.find(u => u.id === 'friends');
            const friendChanceBonus = gameState.skills.friends * upgradeData.bonus;

            gameState.friends.forEach(friend => {
                const loanAmount = friend.maxLoan;
                const repaymentAmount = friend.repayment || loanAmount;
                const finalChance = Math.min(friend.chance + friendChanceBonus, 0.99);

                const el = document.createElement('div'); el.className = 'option';
                let button;
                
                if (friend.debtAmount > 0) {
                    const status = `(ДОЛЖОК: ${friend.debtAmount.toLocaleString()} ₽)`;
                    const isDisabled = gameState.money < friend.debtAmount;
                    button = `<button class="repay" ${isDisabled ? 'disabled' : ''} onclick="repayFriend('${friend.name}')">Вернуть, сука</button>`;
                    el.innerHTML = `<strong>${friend.name}</strong> ${status}<br><small>${friend.desc}</small><small style="color:${isDisabled ? 'var(--danger)' : 'var(--success)'}">Нужно: ${friend.debtAmount.toLocaleString()} ₽</small>${button}`;
                } else {
                    const extraInfo = friend.repayment ? ` (Вернуть ${repaymentAmount.toLocaleString()} ₽ - не забудь, пидор)` : '';
                    const chanceDisplay = `Шанс: ${Math.round(finalChance * 100)}%`;
                    button = `<button onclick="borrowFromFriend('${friend.name}')">Занять (захуячить)</button>`;
                    el.innerHTML = `<strong>${friend.name}</strong> (${loanAmount.toLocaleString()} ₽)${extraInfo}<br><small>${friend.desc}</small><small style="color:var(--text-low)">${chanceDisplay}</small>${button}`;
                }
                
                container.appendChild(el);
            });
            showModal('friends-modal');
        }
        
        function borrowFromFriend(name) {
            const friend = gameState.friends.find(f => f.name === name);
            const loanAmount = friend.maxLoan;
            
            const upgradeData = UPGRADES.find(u => u.id === 'friends');
            const friendChanceBonus = gameState.skills.friends * upgradeData.bonus;
            const finalChance = friend.chance + friendChanceBonus;

            if (friend.debtAmount > 0) { showToast(`${friend.name}: Сначала верни старое, пёс!`, 'warning'); audioSystem.play('fail'); return; }
            if (gameState.debt > 150000) { showToast(`${friend.name}: Слышал про твой долг Злому. Нахуй, я пас.`, 'danger'); changeStat('stress', 5); audioSystem.play('threat'); return; }

            if (Math.random() <= finalChance) {
                const actualLoan = loanAmount;
                const repaymentAmount = friend.repayment || actualLoan;
                
                changeStat('money', actualLoan); 
                friend.debtAmount = repaymentAmount; 
                showToast(`${friend.name} одолжил ${actualLoan.toLocaleString()} ₽. Верни ${repaymentAmount.toLocaleString()} ₽, сука! **УРА**`, 'success');
                addEvent(`Занял у ${friend.name}: ${actualLoan.toLocaleString()} ₽. Вернуть: ${repaymentAmount.toLocaleString()} ₽.`, 'success', 'fa-handshake-angle');
                audioSystem.play('money');
            } else {
                changeStat('stress', 15);
                showToast(`${friend.name} ${phrases.friendReject[Math.floor(Math.random() * phrases.friendReject.length)]} 🖕 **ЛОХ**`, 'danger');
                audioSystem.play('fail');
                setStepaAnimation('danger-shake', 1);
            }
            hideModal('friends-modal'); updateUI(); saveGame();
        }

        function repayFriend(name) {
             const friend = gameState.friends.find(f => f.name === name);
             if (gameState.money < friend.debtAmount) { showToast(`Нет бабок, чтобы вернуть долг ${friend.debtAmount.toLocaleString()} ₽, пиздец! 😭`, "danger"); audioSystem.play('fail'); return; }
             
             changeStat('money', -friend.debtAmount);
             showToast(`Ты вернул долг ${friend.name}. Он снова считает тебя человеком. Красава. **ПАЦАН** 🤝`, 'success');
             addEvent(`Вернул долг ${friend.debtAmount.toLocaleString()} ₽. ${friend.name} доволен.`, 'success', 'fa-money-bill-transfer');
             friend.debtAmount = 0;
             audioSystem.play('success');
             hideModal('friends-modal'); updateUI(); saveGame();
        }

        function showFoodModal() {
            const container = document.getElementById('food-options'); container.innerHTML = '';
            food.forEach(item => {
                const el = document.createElement('div'); el.className = 'option';
                const healthText = item.health === 0 ? '0' : (item.health > 0 ? `+${item.health}` : `${item.health}`);
                const stressText = item.stress === 0 ? '0' : (item.stress > 0 ? `+${item.stress}` : `${item.stress}`);
                const isDisabled = gameState.money < item.cost;
                
                el.innerHTML = `<strong><i class="fa-solid ${item.icon}"></i> ${item.name}</strong> - ${item.cost.toLocaleString()} ₽<br><small>Сытость: +${item.satiety}, Здоровье: ${healthText}, Стресс: ${stressText}</small><button ${isDisabled ? 'disabled' : ''} onclick="eat('${item.name}')">Скушать, блядь</button>`;
                container.appendChild(el);
            });
            showModal('food-modal');
        }

        function eat(name) {
            const foodItem = food.find(f => f.name === name);
            if (gameState.money < foodItem.cost) { showToast("Денег нет даже на еду, иди работай, хуесос!", "danger"); audioSystem.play('fail'); return; }
            
            changeStat('money', -foodItem.cost); 
            changeStat('satiety', foodItem.satiety); 
            changeStat('health', foodItem.health); 
            changeStat('stress', foodItem.stress);
            
            addEvent(`Поел: ${foodItem.name}. Заткнул свое ебало. Хоть какая-то радость. **МНЯМ**`, 'success', foodItem.icon);
            audioSystem.play('success');
            hideModal('food-modal'); 
            nextDay(); 
        }

        function showShadyDealsModal() {
            const container = document.getElementById('shady-deals-options'); container.innerHTML = '';
            shadyDeals.forEach(deal => {
                const el = document.createElement('div');
                el.className = 'option';
                const cost = deal.cost > 0 ? deal.cost : 0;
                const costDisplay = deal.cost < 0 ? `Начальный капитал: ${Math.abs(deal.cost).toLocaleString()} ₽ (Ты получаешь)` : `Ставка: ${deal.cost.toLocaleString()} ₽`;
                const penaltyDisplay = deal.penalty === 0 ? 'Нет' : Math.abs(deal.penalty).toLocaleString() + ' ₽';
                const healthDisplay = deal.health ? `, Здоровье: ${deal.health}` : '';
                const isDisabled = gameState.money < cost;

                el.innerHTML = `<strong><i class="fa-solid ${deal.icon}"></i> ${deal.name}</strong><br><small>${deal.desc}</small><br><small style="color:var(--text-low)">${costDisplay} | Профит (Успех): ${deal.reward.toLocaleString()} ₽ | Потери (Провал): ${penaltyDisplay}${healthDisplay} | Шанс: ${deal.chance*100}%</small><button ${isDisabled ? 'disabled' : ''} onclick="attemptShadyDeal('${deal.name}')">Рискнуть, блядь</button>`;
                container.appendChild(el);
            });
            showModal('shady-deals-modal');
        }

        function attemptShadyDeal(name) {
            const deal = shadyDeals.find(d => d.name === name);
            const cost = deal.cost > 0 ? deal.cost : 0;
            
            if (gameState.money < cost) {
                showToast("У тебя нет денег на такую авантюру, нищеброд!", 'danger');
                audioSystem.play('fail');
                return;
            }
            if (deal.cost > 0) changeStat('money', -cost);
            else changeStat('money', Math.abs(deal.cost)); 

            changeStat('stress', deal.stress);
            if (deal.health) changeStat('health', deal.health);
            let icon = deal.icon;

            if (Math.random() <= deal.chance) {
                const profit = deal.reward;
                changeStat('money', profit);
                showToast(`Афера удалась, красава! Ты поднял ${profit.toLocaleString()} ₽! 🤘 **WINNER**`, 'success');
                addEvent(`Ты провернул ${deal.name} и сорвал куш. ${gameState.creditor} в ахуе. **ИЗИ**`, 'success', 'fa-hand-holding-dollar');
                audioSystem.play('money');
                setStepaAnimation('doge-vibe', 1.5);
            } else {
                changeStat('money', deal.penalty);
                showToast(`Тебя кинули, лох ебаный! Потеряно ${Math.abs(deal.penalty).toLocaleString()} ₽ 🤡 **ОЙ**`, 'danger');
                addEvent(`Схема ${deal.name} провалилась. Ты в еще большей жопе, мудак. **НЕ ФАРТИТ**`, 'danger', 'fa-skull-crossbones');
                audioSystem.play('fail');
                setStepaAnimation('danger-shake', 1.5);
            }
            hideModal('shady-deals-modal');
            nextDay(); 
        }
        
        // --- Случайные события и конец игры ---
        function randomEvent() {
            const events = [
                () => { changeStat('money', 1500); addEvent("Нашёл 1500 ₽ у ларька! Сегодня фартит. **ПОДАРОК** 👍", 'success', 'fa-sack-dollar'); audioSystem.play('money'); },
                () => { if(gameState.money > 2000) { changeStat('money', -2000); showToast("Цыгане развели на 2000 ₽. Лох - это судьба, хули. 🤦‍♂️ **КИДОК**", 'danger'); audioSystem.play('fail'); addEvent("Цыгане развели на 2к. Пиздец.", 'danger', 'fa-comments-dollar'); }},
                () => { changeStat('health', -15); showToast("Простудился под дождем, здоровье ухудшилось. Ебать, ты слабак. 🤧 **СЛАБАК**", 'warning'); addEvent("Заболела спина и жопа. Кажется, это простуда.", 'warning', 'fa-temperature-low');},
                () => { changeStat('stress', -25); showToast("По телеку показали Бригаду. На душе стало тепло. Эх, времена... 😌 **НОСТАЛЬГИЯ**", 'success'); addEvent("Посмотрел любимый сериал, на время отпустило.", 'success', 'fa-tv'); },
                () => { changeStat('health', 5); changeStat('satiety', -5); addEvent("Нашел в мусорке почти целую булку. Слегка подзарядился. **ПЕРЕКУС**", 'success', 'fa-utensils'); audioSystem.play('success'); },
                () => { changeStat('stress', 15); showToast(`Вспомнил, как ${gameState.creditor} смотрел на тебя. Ух, аж пропотел. 🥵 **ТРЕВОГА**`, 'danger'); setStepaAnimation('danger-shake', 1.5); addEvent("Тревога, сука. Я должен бабки.", 'danger', 'fa-face-anxious-sweat'); } 
            ];
            events[Math.floor(Math.random() * events.length)]();
        }
        
        function creditorHarassment() {
            const threat = phrases.debtThreats[Math.floor(Math.random() * phrases.debtThreats.length)];
            showToast(threat.replace("Коллектор Злой", gameState.creditor), 'danger');
            changeStat('stress', 30);
            setStepaAnimation('danger-shake', 1.5);
            audioSystem.play('threat');
            addEvent(`Кредиторский звонок: ${gameState.creditor} шлет угрозы. Надо платить.`, 'danger', 'fa-phone-volume');
        }

        function checkGameOver() {
            if (gameState.gameOver) return;
            
            if (gameState.health <= 0) endGame("💀 СДОХ ОТ ЖИЗНИ", phrases.gameOver.health);
            else if (gameState.stress >= 100) endGame("🤯 ПОЕХАЛ КУКУХОЙ", phrases.gameOver.stress);
            else if (gameState.day > gameState.maxDays && gameState.debt > 0) endGame(`🔫 РАСПРАВА ОТ ${gameState.creditor.toUpperCase()}`, phrases.gameOver.debt); 
            else if (gameState.debt <= 0) endGame("🎉 ПОБЕДА, БЛЯТЬ!", phrases.gameOver.win);
        }

        function endGame(title, text) {
            gameState.gameOver = true; saveGame(); haptic('error');
            document.getElementById('game-over-title').textContent = title;
            document.getElementById('game-over-text').textContent = text.replace("Коллектору Злому", gameState.creditor);
            showModal('game-over-modal');
            if(title.includes('ПОБЕДА') || title.includes('СВАЛИЛ')) audioSystem.play('win');
            else audioSystem.play('gameover');
            ui.actionButtons.forEach(btn => btn.disabled = true);
        }
        
        function restartGame() {
            localStorage.removeItem('stepaGameState');
            initGame(true); 
            hideModal('game-over-modal');
        }

        // --- Сохранение и загрузка ---
        function saveGame() {
            localStorage.setItem('stepaGameState', JSON.stringify(gameState));
        }

        function loadGame() {
            const savedState = localStorage.getItem('stepaGameState');
            if (savedState) {
                const loadedState = JSON.parse(savedState);
                if (loadedState.day && loadedState.money !== undefined) {
                    
                    // Обновление старых сохранений и гарантия наличия новых полей
                    const baseState = JSON.parse(JSON.stringify(initialGameState));
                    Object.keys(baseState).forEach(key => {
                        if (loadedState[key] === undefined) loadedState[key] = baseState[key];
                    });
                    
                    if (!loadedState.friends || loadedState.friends.length !== baseState.friends.length) {
                       loadedState.friends = JSON.parse(JSON.stringify(baseState.friends));
                    } else {
                        loadedState.friends.forEach((f, i) => {
                            // Гарантируем, что новые поля из initialGameState есть
                            if (baseState.friends[i]) {
                                f.maxLoan = baseState.friends[i].maxLoan;
                                f.repayment = baseState.friends[i].repayment;
                                f.desc = baseState.friends[i].desc;
                            }
                        });
                    }
                    
                    // Гарантия, что skills всегда есть, даже если UI удален
                    if (!loadedState.skills) loadedState.skills = initialGameState.skills;

                    const maxHealth = 100 + (loadedState.skills.health || 0) * 10;
                    if (loadedState.health > maxHealth) loadedState.health = maxHealth;
                    
                    gameState = loadedState;
                } else {
                    gameState = JSON.parse(JSON.stringify(initialGameState));
                }
            } else {
                gameState = JSON.parse(JSON.stringify(initialGameState));
            }
        }

        // --- Инициализация ---
        function initGame(forceWelcome = false) {
            loadGame();
            
            document.getElementById('welcome-days').textContent = gameState.maxDays;
            document.getElementById('welcome-escape').textContent = ESCAPE_COST.toLocaleString('ru-RU');

            if (gameState.day === 1 || forceWelcome) {
              addEvent(`Проснулся с бодуна. Кажется, я должен ${gameState.creditor}... Пиздец. **НЕ ВЕЗЕТ**`, "warning", 'fa-face-sad-cry');
              ui.welcomeModal.classList.add('show');
            }

            document.querySelector('.action-btn.escape').innerHTML = `<i class="fa-solid fa-plane-departure"></i>СВАЛИТЬ НАХУЙ (${ESCAPE_COST.toLocaleString('ru-RU')} ₽)`;

            updateUI();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.action-btn, .modal-close, .option button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    haptic('light');
                });
            });
            initGame();
        });
    </script>
</body>
</html>
